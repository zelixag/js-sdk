!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XmovAvatarMP={})}(this,function(e){"use strict";var t,s,o,n,a;e.SDKState=void 0,(t=e.SDKState||(e.SDKState={})).UNINITIALIZED="uninitialized",t.INITIALIZING="initializing",t.INITIALIZED="initialized",t.CONNECTING="connecting",t.CONNECTED="connected",t.RUNNING="running",t.PAUSED="paused",t.DISCONNECTED="disconnected",t.DESTROYED="destroyed",t.ERROR="error",e.ConnectionStatus=void 0,(s=e.ConnectionStatus||(e.ConnectionStatus={})).DISCONNECTED="disconnected",s.CONNECTING="connecting",s.CONNECTED="connected",s.RECONNECTING="reconnecting",s.FAILED="failed",e.ErrorCode=void 0,(o=e.ErrorCode||(e.ErrorCode={}))[o.INIT_FAILED=1e3]="INIT_FAILED",o[o.CONFIG_INVALID=1001]="CONFIG_INVALID",o[o.CANVAS_NOT_FOUND=1002]="CANVAS_NOT_FOUND",o[o.WEBGL_NOT_SUPPORT=1003]="WEBGL_NOT_SUPPORT",o[o.CONNECT_FAILED=2e3]="CONNECT_FAILED",o[o.CONNECT_TIMEOUT=2001]="CONNECT_TIMEOUT",o[o.DISCONNECT=2002]="DISCONNECT",o[o.RECONNECT_FAILED=2003]="RECONNECT_FAILED",o[o.RENDER_FAILED=3e3]="RENDER_FAILED",o[o.CONTEXT_LOST=3001]="CONTEXT_LOST",o[o.FRAME_DROP=3002]="FRAME_DROP",o[o.AUDIO_FAILED=4e3]="AUDIO_FAILED",o[o.AUDIO_NOT_SUPPORT=4001]="AUDIO_NOT_SUPPORT",o[o.AUDIO_DECODE_ERROR=4002]="AUDIO_DECODE_ERROR",o[o.RESOURCE_LOAD_FAILED=5e3]="RESOURCE_LOAD_FAILED",o[o.RESOURCE_NOT_FOUND=5001]="RESOURCE_NOT_FOUND",o[o.RESOURCE_TIMEOUT=5002]="RESOURCE_TIMEOUT",o[o.RESOURCE_PARSE_ERROR=5003]="RESOURCE_PARSE_ERROR",o[o.NETWORK_ERROR=6e3]="NETWORK_ERROR",o[o.REQUEST_TIMEOUT=6001]="REQUEST_TIMEOUT",o[o.REQUEST_FAILED=6002]="REQUEST_FAILED",o[o.WEBSOCKET_ERROR=6003]="WEBSOCKET_ERROR",o[o.AUTHENTICATION_FAILED=7e3]="AUTHENTICATION_FAILED",o[o.PERMISSION_DENIED=7001]="PERMISSION_DENIED",o[o.QUOTA_EXCEEDED=7002]="QUOTA_EXCEEDED",o[o.UNKNOWN_ERROR=9999]="UNKNOWN_ERROR";class i extends Error{constructor(e,t,s){super(t),this.name="SDKError",this.code=e,this.details=s,this.timestamp=Date.now()}}function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}e.ResourceType=void 0,(n=e.ResourceType||(e.ResourceType={})).MODEL="model",n.TEXTURE="texture",n.AUDIO="audio",n.ANIMATION="animation",n.CONFIG="config",n.OTHER="other",e.EventType=void 0,(a=e.EventType||(e.EventType={})).READY="ready",a.DESTROY="destroy",a.CONNECTED="connected",a.DISCONNECTED="disconnected",a.RECONNECTING="reconnecting",a.RENDER_START="render-start",a.RENDER_END="render-end",a.RENDER_ERROR="render-error",a.AUDIO_START="audio-start",a.AUDIO_END="audio-end",a.AUDIO_ERROR="audio-error",a.ANIMATION_START="animation-start",a.ANIMATION_END="animation-end",a.ANIMATION_LOOP="animation-loop",a.RESOURCE_LOADING="resource-loading",a.RESOURCE_LOADED="resource-loaded",a.RESOURCE_ERROR="resource-error",a.STATE_CHANGE="state-change",a.PERFORMANCE="performance",a.ERROR="error";var c={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function o(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function a(e,t,o,a,i){if("function"!=typeof o)throw new TypeError("The listener must be a function");var r=new n(o,a||e,i),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],r]:e._events[c].push(r):(e._events[c]=r,e._eventsCount++),e}function i(e,t){0===--e._eventsCount?e._events=new o:delete e._events[t]}function r(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(s=!1)),r.prototype.eventNames=function(){var e,o,n=[];if(0===this._eventsCount)return n;for(o in e=this._events)t.call(e,o)&&n.push(s?o.slice(1):o);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},r.prototype.listeners=function(e){var t=s?s+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var n=0,a=o.length,i=new Array(a);n<a;n++)i[n]=o[n].fn;return i},r.prototype.listenerCount=function(e){var t=s?s+e:e,o=this._events[t];return o?o.fn?1:o.length:0},r.prototype.emit=function(e,t,o,n,a,i){var r=s?s+e:e;if(!this._events[r])return!1;var c,l,h=this._events[r],d=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,o),!0;case 4:return h.fn.call(h.context,t,o,n),!0;case 5:return h.fn.call(h.context,t,o,n,a),!0;case 6:return h.fn.call(h.context,t,o,n,a,i),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var g,u=h.length;for(l=0;l<u;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),d){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,o);break;case 4:h[l].fn.call(h[l].context,t,o,n);break;default:if(!c)for(g=1,c=new Array(d-1);g<d;g++)c[g-1]=arguments[g];h[l].fn.apply(h[l].context,c)}}return!0},r.prototype.on=function(e,t,s){return a(this,e,t,s,!1)},r.prototype.once=function(e,t,s){return a(this,e,t,s,!0)},r.prototype.removeListener=function(e,t,o,n){var a=s?s+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var r=this._events[a];if(r.fn)r.fn!==t||n&&!r.once||o&&r.context!==o||i(this,a);else{for(var c=0,l=[],h=r.length;c<h;c++)(r[c].fn!==t||n&&!r[c].once||o&&r[c].context!==o)&&l.push(r[c]);l.length?this._events[a]=1===l.length?l[0]:l:i(this,a)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&i(this,t)):(this._events=new o,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=s,r.EventEmitter=r,e.exports=r}(c);var l,h,d=r(c.exports);class g{constructor(e=100){this.emitter=new d,this.eventHistory=new Map,this.maxHistorySize=e}on(e,t,s){this.emitter.on(e,t,s)}once(e,t,s){this.emitter.once(e,t,s)}off(e,t,s){t?this.emitter.off(e,t,s):this.emitter.removeAllListeners(e)}emit(e,...t){this.recordEvent(e,t),this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}eventNames(){return this.emitter.eventNames()}removeAllListeners(e){e?this.emitter.removeAllListeners(e):this.emitter.removeAllListeners()}recordEvent(e,t){this.eventHistory.has(e)||this.eventHistory.set(e,[]);const s=this.eventHistory.get(e);s.push({timestamp:Date.now(),args:t}),s.length>this.maxHistorySize&&s.shift()}getEventHistory(e){return this.eventHistory.get(e)||[]}clearEventHistory(e){e?this.eventHistory.delete(e):this.eventHistory.clear()}destroy(){this.removeAllListeners(),this.eventHistory.clear()}}class u{constructor(t,s=50){this.eventBus=t,this.sdkState=e.SDKState.UNINITIALIZED,this.connectionStatus=e.ConnectionStatus.DISCONNECTED,this.stateHistory=[],this.maxHistorySize=s}getState(){return this.sdkState}setState(t){if(this.sdkState===t)return;const s=this.sdkState;this.sdkState=t,this.recordStateHistory(t),this.eventBus.emit(e.EventType.STATE_CHANGE,{previous:s,current:t,timestamp:Date.now()}),console.log(`[StateManager] State changed: ${s} -> ${t}`)}getConnectionStatus(){return this.connectionStatus}setConnectionStatus(t){if(this.connectionStatus===t)return;const s=this.connectionStatus;switch(this.connectionStatus=t,console.log(`[StateManager] Connection status changed: ${s} -> ${t}`),t){case e.ConnectionStatus.CONNECTED:this.eventBus.emit(e.EventType.CONNECTED);break;case e.ConnectionStatus.DISCONNECTED:this.eventBus.emit(e.EventType.DISCONNECTED);break;case e.ConnectionStatus.RECONNECTING:this.eventBus.emit(e.EventType.RECONNECTING)}}canOperate(){return this.sdkState===e.SDKState.RUNNING||this.sdkState===e.SDKState.PAUSED||this.sdkState===e.SDKState.CONNECTED}isInitialized(){return this.sdkState!==e.SDKState.UNINITIALIZED}isConnected(){return this.connectionStatus===e.ConnectionStatus.CONNECTED}isRunning(){return this.sdkState===e.SDKState.RUNNING}isDestroyed(){return this.sdkState===e.SDKState.DESTROYED}recordStateHistory(e){this.stateHistory.push({state:e,timestamp:Date.now()}),this.stateHistory.length>this.maxHistorySize&&this.stateHistory.shift()}getStateHistory(){return[...this.stateHistory]}getStateDuration(){if(0===this.stateHistory.length)return 0;const e=this.stateHistory[this.stateHistory.length-1];return Date.now()-e.timestamp}reset(){this.sdkState=e.SDKState.UNINITIALIZED,this.connectionStatus=e.ConnectionStatus.DISCONNECTED,this.stateHistory=[]}destroy(){this.setState(e.SDKState.DESTROYED),this.stateHistory=[]}}!function(e){e.INIT="init",e.START="start",e.PAUSE="pause",e.RESUME="resume",e.DESTROY="destroy"}(l||(l={}));class S{constructor(e,t){this.eventBus=e,this.stateManager=t,this.hooks=new Map,this.isPageVisible=!0,this.setupMiniProgramLifecycle()}registerHooks(e,t){this.hooks.set(e,t),console.log(`[LifecycleManager] Registered hooks for module: ${e}`)}unregisterHooks(e){this.hooks.delete(e),console.log(`[LifecycleManager] Unregistered hooks for module: ${e}`)}async init(){if(this.stateManager.isInitialized())throw new i(e.ErrorCode.INIT_FAILED,"SDK already initialized");console.log("[LifecycleManager] Initializing..."),this.stateManager.setState(e.SDKState.INITIALIZING);try{await this.executePhase(l.INIT),this.stateManager.setState(e.SDKState.INITIALIZED),console.log("[LifecycleManager] Initialization completed")}catch(t){throw this.stateManager.setState(e.SDKState.ERROR),new i(e.ErrorCode.INIT_FAILED,"Initialization failed",t)}}async start(){if(!this.stateManager.isInitialized())throw new i(e.ErrorCode.INIT_FAILED,"SDK not initialized");if(this.stateManager.isRunning())console.warn("[LifecycleManager] SDK already running");else{console.log("[LifecycleManager] Starting...");try{await this.executePhase(l.START),this.stateManager.setState(e.SDKState.RUNNING),console.log("[LifecycleManager] Started successfully")}catch(t){throw this.stateManager.setState(e.SDKState.ERROR),new i(e.ErrorCode.INIT_FAILED,"Start failed",t)}}}async pause(){if(this.stateManager.isRunning()){console.log("[LifecycleManager] Pausing...");try{await this.executePhase(l.PAUSE),this.stateManager.setState(e.SDKState.PAUSED),console.log("[LifecycleManager] Paused successfully")}catch(e){console.error("[LifecycleManager] Pause failed:",e)}}else console.warn("[LifecycleManager] SDK not running")}async resume(){if(this.stateManager.getState()===e.SDKState.PAUSED){console.log("[LifecycleManager] Resuming...");try{await this.executePhase(l.RESUME),this.stateManager.setState(e.SDKState.RUNNING),console.log("[LifecycleManager] Resumed successfully")}catch(e){console.error("[LifecycleManager] Resume failed:",e)}}else console.warn("[LifecycleManager] SDK not paused")}async destroy(){if(this.stateManager.isDestroyed())console.warn("[LifecycleManager] SDK already destroyed");else{console.log("[LifecycleManager] Destroying...");try{await this.executePhase(l.DESTROY),this.stateManager.destroy(),this.hooks.clear(),console.log("[LifecycleManager] Destroyed successfully")}catch(e){console.error("[LifecycleManager] Destroy failed:",e)}}}async executePhase(e){const t=`on${e.charAt(0).toUpperCase()+e.slice(1)}`,s=[];for(const[e,o]of this.hooks){const n=o[t];n&&(console.log(`[LifecycleManager] Executing ${t} for ${e}`),s.push(n().catch(s=>{throw console.error(`[LifecycleManager] ${t} failed for ${e}:`,s),s})))}await Promise.all(s)}setupMiniProgramLifecycle(){var t,s;"undefined"!=typeof wx&&(null===(t=wx.onAppShow)||void 0===t||t.call(wx,()=>{console.log("[LifecycleManager] App show"),this.isPageVisible=!0,this.stateManager.getState()===e.SDKState.PAUSED&&this.resume().catch(e=>{console.error("[LifecycleManager] Auto resume failed:",e)})}),null===(s=wx.onAppHide)||void 0===s||s.call(wx,()=>{console.log("[LifecycleManager] App hide"),this.isPageVisible=!1,this.stateManager.isRunning()&&this.pause().catch(e=>{console.error("[LifecycleManager] Auto pause failed:",e)})}))}getPageVisibility(){return this.isPageVisible}}class E{constructor(e){this.webSocket=null,this.sessionId="",this.canvas=null,this.gl=null,this.validateConfig(e),this.config=this.mergeDefaultConfig(e),this.eventBus=new g,this.stateManager=new u(this.eventBus),this.lifecycleManager=new S(this.eventBus,this.stateManager),this.modules=new Map,this.plugins=new Map,console.log("[AvatarSDK] SDK instance created")}async init(){try{console.log("[AvatarSDK] Initializing SDK..."),this.stateManager.setState(e.SDKState.INITIALIZING),console.log("[AvatarSDK] Step 1: Getting canvas node..."),await this.initCanvas(),console.log("[AvatarSDK] Canvas node obtained"),console.log("[AvatarSDK] Step 2: Creating WebGL context..."),await this.initWebGL(),console.log("[AvatarSDK] WebGL context created"),console.log("[AvatarSDK] Step 3: Connecting to WebSocket server..."),await this.connectWebSocket(),console.log("[AvatarSDK] WebSocket connected"),console.log("[AvatarSDK] Step 4: Sending init message..."),await this.sendInitMessage(),console.log("[AvatarSDK] Init message sent"),await this.lifecycleManager.init(),this.stateManager.setState(e.SDKState.INITIALIZED),this.eventBus.emit(e.EventType.READY),this.config.onReady&&this.config.onReady(),console.log("[AvatarSDK] SDK initialized successfully")}catch(t){console.error("[AvatarSDK] Initialization failed:",t),this.stateManager.setState(e.SDKState.ERROR);const s=t instanceof i?t:new i(e.ErrorCode.INIT_FAILED,"Initialization failed",t);throw this.handleError(s),s}}async initCanvas(){return new Promise((t,s)=>{wx.createSelectorQuery().select(`#${this.config.canvas.id}`).fields({node:!0,size:!0}).exec(o=>{if(!o||!o[0]||!o[0].node)return void s(new i(e.ErrorCode.CANVAS_NOT_FOUND,`Canvas not found: ${this.config.canvas.id}`));this.canvas=o[0].node;const n=wx.getSystemInfoSync().pixelRatio;this.canvas.width=o[0].width*n,this.canvas.height=o[0].height*n,console.log(`[AvatarSDK] Canvas size: ${this.canvas.width}x${this.canvas.height}`),t()})})}async initWebGL(){var t;if(!this.canvas)throw new i(e.ErrorCode.CANVAS_NOT_FOUND,"Canvas not initialized");if(this.gl=this.canvas.getContext("webgl",{antialias:!1!==(null===(t=this.config.render)||void 0===t?void 0:t.antialias),preserveDrawingBuffer:!0}),!this.gl)throw new i(e.ErrorCode.WEBGL_NOT_SUPPORT,"Failed to create WebGL context");this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),console.log("[AvatarSDK] WebGL context created successfully")}async connectWebSocket(){const t=this.buildWebSocketUrl();return console.log("[AvatarSDK] Connecting to:",t),new Promise((s,o)=>{var n;const a=setTimeout(()=>{o(new i(e.ErrorCode.CONNECT_TIMEOUT,"WebSocket connection timeout"))},(null===(n=this.config.network)||void 0===n?void 0:n.timeout)||1e4);this.webSocket=wx.connectSocket({url:t,success:()=>{console.log("[AvatarSDK] WebSocket created")},fail:t=>{clearTimeout(a),o(new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to create WebSocket",t))}}),this.webSocket.onOpen(()=>{clearTimeout(a),console.log("[AvatarSDK] WebSocket connection opened"),this.stateManager.setConnectionStatus(e.ConnectionStatus.CONNECTED),this.eventBus.emit(e.EventType.CONNECTED),s()}),this.webSocket.onMessage(e=>{this.handleWebSocketMessage(e.data)}),this.webSocket.onError(t=>{console.error("[AvatarSDK] WebSocket error:",t),this.handleError(new i(e.ErrorCode.WEBSOCKET_ERROR,"WebSocket error",t))}),this.webSocket.onClose(t=>{console.log("[AvatarSDK] WebSocket closed:",t.code,t.reason),this.stateManager.setConnectionStatus(e.ConnectionStatus.DISCONNECTED),this.eventBus.emit(e.EventType.DISCONNECTED)})})}buildWebSocketUrl(){const e=new URL(this.config.serverUrl);return e.searchParams.set("appId",this.config.appId),e.searchParams.set("appSecret",this.config.appSecret),e.searchParams.set("sdkVersion","2.0.0"),e.searchParams.set("platform","miniprogram"),e.toString()}async sendInitMessage(){var t,s;if(!this.webSocket)throw new i(e.ErrorCode.WEBSOCKET_ERROR,"WebSocket not connected");this.sessionId="session_"+Date.now().toString(36)+"_"+Math.random().toString(36).substr(2,9);const o={type:"init_session",sessionId:this.sessionId,canvasInfo:{width:(null===(t=this.canvas)||void 0===t?void 0:t.width)||0,height:(null===(s=this.canvas)||void 0===s?void 0:s.height)||0},userAgent:"miniprogram",sdkVersion:"2.0.0",timestamp:Date.now()};return this.webSocket.send({data:JSON.stringify(o)}),console.log("[AvatarSDK] Init message sent:",o),new Promise(e=>{setTimeout(()=>{console.log("[AvatarSDK] Init message sent, continuing..."),e()},2e3)})}handleWebSocketMessage(t){var s,o;try{const n="string"==typeof t?JSON.parse(t):t;switch(console.log("[AvatarSDK] WebSocket message received:",n.type),this.eventBus.emit("message",n),n.type){case"session_started":console.log("[AvatarSDK] Session started");break;case"render_data":break;case"error":this.handleError(new i((null===(s=n.payload)||void 0===s?void 0:s.code)||e.ErrorCode.UNKNOWN_ERROR,(null===(o=n.payload)||void 0===o?void 0:o.message)||"Unknown error"))}}catch(e){console.error("[AvatarSDK] Failed to handle WebSocket message:",e)}}async start(){try{console.log("[AvatarSDK] Starting SDK..."),await this.lifecycleManager.start(),console.log("[AvatarSDK] SDK started successfully")}catch(e){throw console.error("[AvatarSDK] Start failed:",e),e}}async pause(){try{console.log("[AvatarSDK] Pausing SDK..."),await this.lifecycleManager.pause(),console.log("[AvatarSDK] SDK paused successfully")}catch(e){throw console.error("[AvatarSDK] Pause failed:",e),e}}async resume(){try{console.log("[AvatarSDK] Resuming SDK..."),await this.lifecycleManager.resume(),console.log("[AvatarSDK] SDK resumed successfully")}catch(e){throw console.error("[AvatarSDK] Resume failed:",e),e}}async destroy(){try{console.log("[AvatarSDK] Destroying SDK..."),await this.lifecycleManager.destroy();for(const[e,t]of this.modules)t.destroy&&await t.destroy();this.modules.clear();for(const[e,t]of this.plugins)t.uninstall&&t.uninstall();this.plugins.clear(),this.eventBus.emit(e.EventType.DESTROY),this.eventBus.destroy(),console.log("[AvatarSDK] SDK destroyed successfully")}catch(e){throw console.error("[AvatarSDK] Destroy failed:",e),e}}async speak(t,s){if(!this.stateManager.canOperate())throw new i(e.ErrorCode.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Speaking:",t)}async playAnimation(t,s){if(!this.stateManager.canOperate())throw new i(e.ErrorCode.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Playing animation:",t)}async stopAnimation(){console.log("[AvatarSDK] Stopping animation")}getState(){return this.stateManager.getState()}getStatus(){return this.stateManager.getConnectionStatus()}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}use(e){this.plugins.has(e.name)?console.warn(`[AvatarSDK] Plugin ${e.name} already installed`):(console.log(`[AvatarSDK] Installing plugin: ${e.name} v${e.version}`),e.install(this),this.plugins.set(e.name,e))}registerModule(e,t){this.modules.has(e)?console.warn(`[AvatarSDK] Module ${e} already registered`):(console.log(`[AvatarSDK] Registering module: ${e}`),this.modules.set(e,t))}getModule(e){return this.modules.get(e)}getConfig(){return{...this.config}}getEventBus(){return this.eventBus}getStateManager(){return this.stateManager}getLifecycleManager(){return this.lifecycleManager}validateConfig(t){if(!t.appId)throw new i(e.ErrorCode.CONFIG_INVALID,"appId is required");if(!t.appSecret)throw new i(e.ErrorCode.CONFIG_INVALID,"appSecret is required");if(!t.serverUrl)throw new i(e.ErrorCode.CONFIG_INVALID,"serverUrl is required");if(!t.canvas||!t.canvas.id)throw new i(e.ErrorCode.CONFIG_INVALID,"canvas.id is required")}mergeDefaultConfig(e){return{...e,render:{quality:"auto",fps:30,enableOptimization:!0,backgroundColor:"#000000",antialias:!0,...e.render},audio:{enabled:!0,volume:1,autoPlay:!0,format:"mp3",...e.audio},network:{timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...e.network},cache:{enabled:!0,maxSize:50,ttl:36e5,strategy:"hybrid",...e.cache},logger:{level:"info",upload:!1,console:!0,...e.logger}}}handleError(t){console.error("[AvatarSDK] Error:",t),this.eventBus.emit(e.EventType.ERROR,t),this.config.onError&&this.config.onError(t)}}!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(h||(h={}));class p{constructor(e={}){this.logs=[],this.maxLogs=1e3,this.levelPriority={debug:0,info:1,warn:2,error:3},this.config={level:"info",upload:!1,console:!0,...e}}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}log(e,t,s){if(this.levelPriority[e]<this.levelPriority[this.config.level])return;const o={level:e,message:t,data:s,timestamp:Date.now()};"error"===e&&s instanceof Error&&(o.stack=s.stack),this.logs.push(o),this.logs.length>this.maxLogs&&this.logs.shift(),this.config.console&&this.consoleLog(o),this.config.upload&&"error"===e&&this.uploadLog(o)}consoleLog(e){const t=`${`[${this.formatTime(e.timestamp)}] [${e.level.toUpperCase()}]`} ${e.message}`;switch(e.level){case"debug":console.debug(t,e.data||"");break;case"info":console.log(t,e.data||"");break;case"warn":console.warn(t,e.data||"");break;case"error":console.error(t,e.data||""),e.stack&&console.error(e.stack)}}uploadLog(e){this.config.uploadUrl&&wx.request({url:this.config.uploadUrl,method:"POST",data:e,fail:e=>{console.error("[Logger] Failed to upload log:",e)}})}getLogs(e){return e?this.logs.filter(t=>t.level===e):[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}formatTime(e){const t=new Date(e);return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}.${String(t.getMilliseconds()).padStart(3,"0")}`}setLevel(e){this.config.level=e}setUpload(e){this.config.upload=e}setUploadUrl(e){this.config.uploadUrl=e}}const f=new p;e.AvatarSDK=E,e.CanvasAdapter=class{constructor(e){this.canvas=null,this.context=null,this.canvasId=e.id,this.canvasType=e.type||"webgl",this.width=e.width||375,this.height=e.height||667,this.pixelRatio=e.pixelRatio||wx.getSystemInfoSync().pixelRatio||2}async init(){try{if(console.log("[CanvasAdapter] Initializing canvas:",this.canvasId),this.canvas=await this.getCanvasNode(),!this.canvas)throw new i(e.ErrorCode.CANVAS_NOT_FOUND,`Canvas not found: ${this.canvasId}`);if(this.setSize(this.width,this.height),"webgl"===this.canvasType?this.context=this.createWebGLContext():this.context=this.canvas.getContext("2d"),!this.context)throw new i(e.ErrorCode.WEBGL_NOT_SUPPORT,"Failed to create canvas context");console.log("[CanvasAdapter] Canvas initialized successfully")}catch(e){throw console.error("[CanvasAdapter] Initialization failed:",e),e}}async getCanvasNode(){return new Promise((t,s)=>{wx.createSelectorQuery().select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec(o=>{o&&o[0]&&o[0].node?t(o[0].node):s(new i(e.ErrorCode.CANVAS_NOT_FOUND,`Canvas node not found: ${this.canvasId}`))})})}createWebGLContext(){if(!this.canvas)return null;try{const t=this.canvas.getContext("webgl");if(!t)throw new i(e.ErrorCode.WEBGL_NOT_SUPPORT,"WebGL not supported");return t.viewport(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),t.enable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),console.log("[CanvasAdapter] WebGL context created"),t}catch(e){throw console.error("[CanvasAdapter] Failed to create WebGL context:",e),e}}setSize(e,t){if(this.canvas&&(this.width=e,this.height=t,this.canvas.width=e*this.pixelRatio,this.canvas.height=t*this.pixelRatio,console.log(`[CanvasAdapter] Canvas size set to ${e}x${t} (${this.canvas.width}x${this.canvas.height})`),this.context&&"webgl"===this.canvasType)){this.context.viewport(0,0,this.canvas.width,this.canvas.height)}}clear(e){if(this.context)if("webgl"===this.canvasType){const t=this.context,s=this.parseColor(e||"#000000");t.clearColor(s[0],s[1],s[2],s[3]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}else{const t=this.context;t.clearRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),e&&(t.fillStyle=e,t.fillRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio))}}getCanvas(){return this.canvas}getContext(){return this.context}getWebGLContext(){return"webgl"===this.canvasType?this.context:null}get2DContext(){return"2d"===this.canvasType?this.context:null}getSize(){return{width:this.width,height:this.height}}getPixelRatio(){return this.pixelRatio}async toDataURL(t="image/png",s=1){if(!this.canvas)throw new i(e.ErrorCode.CANVAS_NOT_FOUND,"Canvas not initialized");return new Promise((o,n)=>{wx.canvasToTempFilePath({canvas:this.canvas,fileType:t.replace("image/",""),quality:s,success:e=>{o(e.tempFilePath)},fail:t=>{n(new i(e.ErrorCode.RENDER_FAILED,"Failed to export canvas",t))}})})}parseColor(e){let t=0,s=0,o=0,n=1;if(e.startsWith("#")){const a=e.slice(1);6===a.length?(t=parseInt(a.slice(0,2),16)/255,s=parseInt(a.slice(2,4),16)/255,o=parseInt(a.slice(4,6),16)/255):8===a.length&&(t=parseInt(a.slice(0,2),16)/255,s=parseInt(a.slice(2,4),16)/255,o=parseInt(a.slice(4,6),16)/255,n=parseInt(a.slice(6,8),16)/255)}return[t,s,o,n]}destroy(){this.context=null,this.canvas=null,console.log("[CanvasAdapter] Canvas adapter destroyed")}},e.EventBus=g,e.LifecycleManager=S,e.Logger=p,e.SDKError=i,e.StateManager=u,e.WebSocketAdapter=class extends d{constructor(e,t={}){super(),this.socket=null,this.state=h.CLOSED,this.reconnectTimer=null,this.heartbeatTimer=null,this.reconnectAttempts=0,this.messageQueue=[],this.isManualClose=!1,this.url=e,this.config={timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...t}}async connect(){if(this.state!==h.OPEN&&this.state!==h.CONNECTING)return new Promise((t,s)=>{try{console.log("[WebSocketAdapter] Connecting to:",this.url),this.state=h.CONNECTING,this.isManualClose=!1,this.socket=wx.connectSocket({url:this.url,timeout:this.config.timeout,success:()=>{console.log("[WebSocketAdapter] Socket created")},fail:t=>{console.error("[WebSocketAdapter] Failed to create socket:",t),this.state=h.CLOSED,s(new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to create WebSocket",t))}}),this.setupSocketListeners(t,s);const o=setTimeout(()=>{this.state===h.CONNECTING&&(this.close(),s(new i(e.ErrorCode.CONNECT_TIMEOUT,"WebSocket connection timeout")))},this.config.timeout);this.once("open",()=>{clearTimeout(o)})}catch(t){this.state=h.CLOSED,s(new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to connect WebSocket",t))}});console.warn("[WebSocketAdapter] Already connected or connecting")}setupSocketListeners(t,s){this.socket&&(this.socket.onOpen(()=>{console.log("[WebSocketAdapter] Connection opened"),this.state=h.OPEN,this.reconnectAttempts=0,this.flushMessageQueue(),this.startHeartbeat(),this.emit("open"),t()}),this.socket.onMessage(t=>{try{const e="string"==typeof t.data?JSON.parse(t.data):t.data;this.emit("message",e)}catch(t){console.error("[WebSocketAdapter] Failed to parse message:",t),this.emit("error",new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to parse message",t))}}),this.socket.onError(t=>{console.error("[WebSocketAdapter] Connection error:",t),this.emit("error",new i(e.ErrorCode.WEBSOCKET_ERROR,"WebSocket error",t))}),this.socket.onClose(e=>{console.log("[WebSocketAdapter] Connection closed:",e.code,e.reason),this.state=h.CLOSED,this.stopHeartbeat(),this.emit("close",{code:e.code,reason:e.reason}),!this.isManualClose&&this.config.autoReconnect&&this.scheduleReconnect()}))}send(t){if(this.state!==h.OPEN)return console.warn("[WebSocketAdapter] Connection not open, queueing message"),void this.messageQueue.push(t);try{const s="string"==typeof t?t:JSON.stringify(t);this.socket.send({data:s,success:()=>{console.log("[WebSocketAdapter] Message sent")},fail:t=>{console.error("[WebSocketAdapter] Failed to send message:",t),this.emit("error",new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to send message",t))}})}catch(t){console.error("[WebSocketAdapter] Failed to serialize message:",t),this.emit("error",new i(e.ErrorCode.WEBSOCKET_ERROR,"Failed to serialize message",t))}}close(e=1e3,t="Normal closure"){console.log("[WebSocketAdapter] Closing connection"),this.isManualClose=!0,this.stopHeartbeat(),this.stopReconnect(),this.socket&&this.state!==h.CLOSED&&(this.state=h.CLOSING,this.socket.close({code:e,reason:t,success:()=>{console.log("[WebSocketAdapter] Connection closed successfully")},fail:e=>{console.error("[WebSocketAdapter] Failed to close connection:",e)}})),this.socket=null,this.state=h.CLOSED}flushMessageQueue(){if(0!==this.messageQueue.length)for(console.log(`[WebSocketAdapter] Flushing ${this.messageQueue.length} queued messages`);this.messageQueue.length>0;){const e=this.messageQueue.shift();this.send(e)}}startHeartbeat(){this.config.heartbeatInterval&&!this.heartbeatTimer&&(console.log("[WebSocketAdapter] Starting heartbeat"),this.heartbeatTimer=setInterval(()=>{this.state===h.OPEN&&this.send({type:"ping",timestamp:Date.now()})},this.config.heartbeatInterval))}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,console.log("[WebSocketAdapter] Heartbeat stopped"))}scheduleReconnect(){if(this.reconnectTimer||this.isManualClose)return;if(this.reconnectAttempts>=this.config.retryTimes)return console.error("[WebSocketAdapter] Max reconnect attempts reached"),void this.emit("error",new i(e.ErrorCode.RECONNECT_FAILED,"Max reconnect attempts reached"));this.reconnectAttempts++;const t=this.config.reconnectDelay*this.reconnectAttempts;console.log(`[WebSocketAdapter] Reconnecting in ${t}ms (attempt ${this.reconnectAttempts}/${this.config.retryTimes})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect().catch(e=>{console.error("[WebSocketAdapter] Reconnect failed:",e)})},t)}stopReconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null,console.log("[WebSocketAdapter] Reconnect stopped"))}getState(){return this.state}isConnected(){return this.state===h.OPEN}destroy(){this.close(),this.removeAllListeners(),this.messageQueue=[],console.log("[WebSocketAdapter] WebSocket adapter destroyed")}},e.default=E,e.logger=f,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
