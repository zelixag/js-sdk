var e,t,s,n,o;!function(e){e.UNINITIALIZED="uninitialized",e.INITIALIZING="initializing",e.INITIALIZED="initialized",e.CONNECTING="connecting",e.CONNECTED="connected",e.RUNNING="running",e.PAUSED="paused",e.DISCONNECTED="disconnected",e.DESTROYED="destroyed",e.ERROR="error"}(e||(e={})),function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.FAILED="failed"}(t||(t={})),function(e){e[e.INIT_FAILED=1e3]="INIT_FAILED",e[e.CONFIG_INVALID=1001]="CONFIG_INVALID",e[e.CANVAS_NOT_FOUND=1002]="CANVAS_NOT_FOUND",e[e.WEBGL_NOT_SUPPORT=1003]="WEBGL_NOT_SUPPORT",e[e.CONNECT_FAILED=2e3]="CONNECT_FAILED",e[e.CONNECT_TIMEOUT=2001]="CONNECT_TIMEOUT",e[e.DISCONNECT=2002]="DISCONNECT",e[e.RECONNECT_FAILED=2003]="RECONNECT_FAILED",e[e.RENDER_FAILED=3e3]="RENDER_FAILED",e[e.CONTEXT_LOST=3001]="CONTEXT_LOST",e[e.FRAME_DROP=3002]="FRAME_DROP",e[e.AUDIO_FAILED=4e3]="AUDIO_FAILED",e[e.AUDIO_NOT_SUPPORT=4001]="AUDIO_NOT_SUPPORT",e[e.AUDIO_DECODE_ERROR=4002]="AUDIO_DECODE_ERROR",e[e.RESOURCE_LOAD_FAILED=5e3]="RESOURCE_LOAD_FAILED",e[e.RESOURCE_NOT_FOUND=5001]="RESOURCE_NOT_FOUND",e[e.RESOURCE_TIMEOUT=5002]="RESOURCE_TIMEOUT",e[e.RESOURCE_PARSE_ERROR=5003]="RESOURCE_PARSE_ERROR",e[e.NETWORK_ERROR=6e3]="NETWORK_ERROR",e[e.REQUEST_TIMEOUT=6001]="REQUEST_TIMEOUT",e[e.REQUEST_FAILED=6002]="REQUEST_FAILED",e[e.WEBSOCKET_ERROR=6003]="WEBSOCKET_ERROR",e[e.AUTHENTICATION_FAILED=7e3]="AUTHENTICATION_FAILED",e[e.PERMISSION_DENIED=7001]="PERMISSION_DENIED",e[e.QUOTA_EXCEEDED=7002]="QUOTA_EXCEEDED",e[e.UNKNOWN_ERROR=9999]="UNKNOWN_ERROR"}(s||(s={}));class i extends Error{constructor(e,t,s){super(t),this.name="SDKError",this.code=e,this.details=s,this.timestamp=Date.now()}}function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}!function(e){e.MODEL="model",e.TEXTURE="texture",e.AUDIO="audio",e.ANIMATION="animation",e.CONFIG="config",e.OTHER="other"}(n||(n={})),function(e){e.READY="ready",e.DESTROY="destroy",e.CONNECTED="connected",e.DISCONNECTED="disconnected",e.RECONNECTING="reconnecting",e.RENDER_START="render-start",e.RENDER_END="render-end",e.RENDER_ERROR="render-error",e.AUDIO_START="audio-start",e.AUDIO_END="audio-end",e.AUDIO_ERROR="audio-error",e.ANIMATION_START="animation-start",e.ANIMATION_END="animation-end",e.ANIMATION_LOOP="animation-loop",e.RESOURCE_LOADING="resource-loading",e.RESOURCE_LOADED="resource-loaded",e.RESOURCE_ERROR="resource-error",e.STATE_CHANGE="state-change",e.PERFORMANCE="performance",e.ERROR="error"}(o||(o={}));var r={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function n(){}function o(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,n,i,a){if("function"!=typeof n)throw new TypeError("The listener must be a function");var r=new o(n,i||e,a),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],r]:e._events[c].push(r):(e._events[c]=r,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function r(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),r.prototype.eventNames=function(){var e,n,o=[];if(0===this._eventsCount)return o;for(n in e=this._events)t.call(e,n)&&o.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},r.prototype.listeners=function(e){var t=s?s+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var o=0,i=n.length,a=new Array(i);o<i;o++)a[o]=n[o].fn;return a},r.prototype.listenerCount=function(e){var t=s?s+e:e,n=this._events[t];return n?n.fn?1:n.length:0},r.prototype.emit=function(e,t,n,o,i,a){var r=s?s+e:e;if(!this._events[r])return!1;var c,l,h=this._events[r],g=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),g){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,n),!0;case 4:return h.fn.call(h.context,t,n,o),!0;case 5:return h.fn.call(h.context,t,n,o,i),!0;case 6:return h.fn.call(h.context,t,n,o,i,a),!0}for(l=1,c=new Array(g-1);l<g;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var u,d=h.length;for(l=0;l<d;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),g){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,n);break;case 4:h[l].fn.call(h[l].context,t,n,o);break;default:if(!c)for(u=1,c=new Array(g-1);u<g;u++)c[u-1]=arguments[u];h[l].fn.apply(h[l].context,c)}}return!0},r.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},r.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},r.prototype.removeListener=function(e,t,n,o){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var r=this._events[i];if(r.fn)r.fn!==t||o&&!r.once||n&&r.context!==n||a(this,i);else{for(var c=0,l=[],h=r.length;c<h;c++)(r[c].fn!==t||o&&!r[c].once||n&&r[c].context!==n)&&l.push(r[c]);l.length?this._events[i]=1===l.length?l[0]:l:a(this,i)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&a(this,t)):(this._events=new n,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=s,r.EventEmitter=r,e.exports=r}(r);var c,l,h=a(r.exports);class g{constructor(e=100){this.emitter=new h,this.eventHistory=new Map,this.maxHistorySize=e}on(e,t,s){this.emitter.on(e,t,s)}once(e,t,s){this.emitter.once(e,t,s)}off(e,t,s){t?this.emitter.off(e,t,s):this.emitter.removeAllListeners(e)}emit(e,...t){this.recordEvent(e,t),this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}eventNames(){return this.emitter.eventNames()}removeAllListeners(e){e?this.emitter.removeAllListeners(e):this.emitter.removeAllListeners()}recordEvent(e,t){this.eventHistory.has(e)||this.eventHistory.set(e,[]);const s=this.eventHistory.get(e);s.push({timestamp:Date.now(),args:t}),s.length>this.maxHistorySize&&s.shift()}getEventHistory(e){return this.eventHistory.get(e)||[]}clearEventHistory(e){e?this.eventHistory.delete(e):this.eventHistory.clear()}destroy(){this.removeAllListeners(),this.eventHistory.clear()}}class u{constructor(s,n=50){this.eventBus=s,this.sdkState=e.UNINITIALIZED,this.connectionStatus=t.DISCONNECTED,this.stateHistory=[],this.maxHistorySize=n}getState(){return this.sdkState}setState(e){if(this.sdkState===e)return;const t=this.sdkState;this.sdkState=e,this.recordStateHistory(e),this.eventBus.emit(o.STATE_CHANGE,{previous:t,current:e,timestamp:Date.now()}),console.log(`[StateManager] State changed: ${t} -> ${e}`)}getConnectionStatus(){return this.connectionStatus}setConnectionStatus(e){if(this.connectionStatus===e)return;const s=this.connectionStatus;switch(this.connectionStatus=e,console.log(`[StateManager] Connection status changed: ${s} -> ${e}`),e){case t.CONNECTED:this.eventBus.emit(o.CONNECTED);break;case t.DISCONNECTED:this.eventBus.emit(o.DISCONNECTED);break;case t.RECONNECTING:this.eventBus.emit(o.RECONNECTING)}}canOperate(){return this.sdkState===e.RUNNING||this.sdkState===e.PAUSED||this.sdkState===e.CONNECTED}isInitialized(){return this.sdkState!==e.UNINITIALIZED}isConnected(){return this.connectionStatus===t.CONNECTED}isRunning(){return this.sdkState===e.RUNNING}isDestroyed(){return this.sdkState===e.DESTROYED}recordStateHistory(e){this.stateHistory.push({state:e,timestamp:Date.now()}),this.stateHistory.length>this.maxHistorySize&&this.stateHistory.shift()}getStateHistory(){return[...this.stateHistory]}getStateDuration(){if(0===this.stateHistory.length)return 0;const e=this.stateHistory[this.stateHistory.length-1];return Date.now()-e.timestamp}reset(){this.sdkState=e.UNINITIALIZED,this.connectionStatus=t.DISCONNECTED,this.stateHistory=[]}destroy(){this.setState(e.DESTROYED),this.stateHistory=[]}}!function(e){e.INIT="init",e.START="start",e.PAUSE="pause",e.RESUME="resume",e.DESTROY="destroy"}(c||(c={}));class d{constructor(e,t){this.eventBus=e,this.stateManager=t,this.hooks=new Map,this.isPageVisible=!0,this.setupMiniProgramLifecycle()}registerHooks(e,t){this.hooks.set(e,t),console.log(`[LifecycleManager] Registered hooks for module: ${e}`)}unregisterHooks(e){this.hooks.delete(e),console.log(`[LifecycleManager] Unregistered hooks for module: ${e}`)}async init(){if(this.stateManager.isInitialized())throw new i(s.INIT_FAILED,"SDK already initialized");console.log("[LifecycleManager] Initializing..."),this.stateManager.setState(e.INITIALIZING);try{await this.executePhase(c.INIT),this.stateManager.setState(e.INITIALIZED),console.log("[LifecycleManager] Initialization completed")}catch(t){throw this.stateManager.setState(e.ERROR),new i(s.INIT_FAILED,"Initialization failed",t)}}async start(){if(!this.stateManager.isInitialized())throw new i(s.INIT_FAILED,"SDK not initialized");if(this.stateManager.isRunning())console.warn("[LifecycleManager] SDK already running");else{console.log("[LifecycleManager] Starting...");try{await this.executePhase(c.START),this.stateManager.setState(e.RUNNING),console.log("[LifecycleManager] Started successfully")}catch(t){throw this.stateManager.setState(e.ERROR),new i(s.INIT_FAILED,"Start failed",t)}}}async pause(){if(this.stateManager.isRunning()){console.log("[LifecycleManager] Pausing...");try{await this.executePhase(c.PAUSE),this.stateManager.setState(e.PAUSED),console.log("[LifecycleManager] Paused successfully")}catch(e){console.error("[LifecycleManager] Pause failed:",e)}}else console.warn("[LifecycleManager] SDK not running")}async resume(){if(this.stateManager.getState()===e.PAUSED){console.log("[LifecycleManager] Resuming...");try{await this.executePhase(c.RESUME),this.stateManager.setState(e.RUNNING),console.log("[LifecycleManager] Resumed successfully")}catch(e){console.error("[LifecycleManager] Resume failed:",e)}}else console.warn("[LifecycleManager] SDK not paused")}async destroy(){if(this.stateManager.isDestroyed())console.warn("[LifecycleManager] SDK already destroyed");else{console.log("[LifecycleManager] Destroying...");try{await this.executePhase(c.DESTROY),this.stateManager.destroy(),this.hooks.clear(),console.log("[LifecycleManager] Destroyed successfully")}catch(e){console.error("[LifecycleManager] Destroy failed:",e)}}}async executePhase(e){const t=`on${e.charAt(0).toUpperCase()+e.slice(1)}`,s=[];for(const[e,n]of this.hooks){const o=n[t];o&&(console.log(`[LifecycleManager] Executing ${t} for ${e}`),s.push(o().catch(s=>{throw console.error(`[LifecycleManager] ${t} failed for ${e}:`,s),s})))}await Promise.all(s)}setupMiniProgramLifecycle(){var t,s;"undefined"!=typeof wx&&(null===(t=wx.onAppShow)||void 0===t||t.call(wx,()=>{console.log("[LifecycleManager] App show"),this.isPageVisible=!0,this.stateManager.getState()===e.PAUSED&&this.resume().catch(e=>{console.error("[LifecycleManager] Auto resume failed:",e)})}),null===(s=wx.onAppHide)||void 0===s||s.call(wx,()=>{console.log("[LifecycleManager] App hide"),this.isPageVisible=!1,this.stateManager.isRunning()&&this.pause().catch(e=>{console.error("[LifecycleManager] Auto pause failed:",e)})}))}getPageVisibility(){return this.isPageVisible}}class S{constructor(e){this.webSocket=null,this.sessionId="",this.canvas=null,this.gl=null,this.validateConfig(e),this.config=this.mergeDefaultConfig(e),this.eventBus=new g,this.stateManager=new u(this.eventBus),this.lifecycleManager=new d(this.eventBus,this.stateManager),this.modules=new Map,this.plugins=new Map,console.log("[AvatarSDK] SDK instance created")}async init(){try{console.log("[AvatarSDK] Initializing SDK..."),this.stateManager.setState(e.INITIALIZING),console.log("[AvatarSDK] Step 1: Getting canvas node..."),await this.initCanvas(),console.log("[AvatarSDK] Canvas node obtained"),console.log("[AvatarSDK] Step 2: Creating WebGL context..."),await this.initWebGL(),console.log("[AvatarSDK] WebGL context created"),console.log("[AvatarSDK] Step 3: Connecting to WebSocket server..."),await this.connectWebSocket(),console.log("[AvatarSDK] WebSocket connected"),console.log("[AvatarSDK] Step 4: Sending init message..."),await this.sendInitMessage(),console.log("[AvatarSDK] Init message sent"),await this.lifecycleManager.init(),this.stateManager.setState(e.INITIALIZED),this.eventBus.emit(o.READY),this.config.onReady&&this.config.onReady(),console.log("[AvatarSDK] SDK initialized successfully")}catch(t){console.error("[AvatarSDK] Initialization failed:",t),this.stateManager.setState(e.ERROR);const n=t instanceof i?t:new i(s.INIT_FAILED,"Initialization failed",t);throw this.handleError(n),n}}async initCanvas(){return new Promise((e,t)=>{wx.createSelectorQuery().select(`#${this.config.canvas.id}`).fields({node:!0,size:!0}).exec(n=>{if(!n||!n[0]||!n[0].node)return void t(new i(s.CANVAS_NOT_FOUND,`Canvas not found: ${this.config.canvas.id}`));this.canvas=n[0].node;const o=wx.getSystemInfoSync().pixelRatio;this.canvas.width=n[0].width*o,this.canvas.height=n[0].height*o,console.log(`[AvatarSDK] Canvas size: ${this.canvas.width}x${this.canvas.height}`),e()})})}async initWebGL(){var e;if(!this.canvas)throw new i(s.CANVAS_NOT_FOUND,"Canvas not initialized");if(this.gl=this.canvas.getContext("webgl",{antialias:!1!==(null===(e=this.config.render)||void 0===e?void 0:e.antialias),preserveDrawingBuffer:!0}),!this.gl)throw new i(s.WEBGL_NOT_SUPPORT,"Failed to create WebGL context");this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),console.log("[AvatarSDK] WebGL context created successfully")}async connectWebSocket(){const e=this.buildWebSocketUrl();return console.log("[AvatarSDK] Connecting to:",e),new Promise((n,a)=>{var r;const c=setTimeout(()=>{a(new i(s.CONNECT_TIMEOUT,"WebSocket connection timeout"))},(null===(r=this.config.network)||void 0===r?void 0:r.timeout)||1e4);this.webSocket=wx.connectSocket({url:e,success:()=>{console.log("[AvatarSDK] WebSocket created")},fail:e=>{clearTimeout(c),a(new i(s.WEBSOCKET_ERROR,"Failed to create WebSocket",e))}}),this.webSocket.onOpen(()=>{clearTimeout(c),console.log("[AvatarSDK] WebSocket connection opened"),this.stateManager.setConnectionStatus(t.CONNECTED),this.eventBus.emit(o.CONNECTED),n()}),this.webSocket.onMessage(e=>{this.handleWebSocketMessage(e.data)}),this.webSocket.onError(e=>{console.error("[AvatarSDK] WebSocket error:",e),this.handleError(new i(s.WEBSOCKET_ERROR,"WebSocket error",e))}),this.webSocket.onClose(e=>{console.log("[AvatarSDK] WebSocket closed:",e.code,e.reason),this.stateManager.setConnectionStatus(t.DISCONNECTED),this.eventBus.emit(o.DISCONNECTED)})})}buildWebSocketUrl(){const e=new URL(this.config.serverUrl);return e.searchParams.set("appId",this.config.appId),e.searchParams.set("appSecret",this.config.appSecret),e.searchParams.set("sdkVersion","2.0.0"),e.searchParams.set("platform","miniprogram"),e.toString()}async sendInitMessage(){var e,t;if(!this.webSocket)throw new i(s.WEBSOCKET_ERROR,"WebSocket not connected");this.sessionId="session_"+Date.now().toString(36)+"_"+Math.random().toString(36).substr(2,9);const n={type:"init_session",sessionId:this.sessionId,canvasInfo:{width:(null===(e=this.canvas)||void 0===e?void 0:e.width)||0,height:(null===(t=this.canvas)||void 0===t?void 0:t.height)||0},userAgent:"miniprogram",sdkVersion:"2.0.0",timestamp:Date.now()};return this.webSocket.send({data:JSON.stringify(n)}),console.log("[AvatarSDK] Init message sent:",n),new Promise(e=>{setTimeout(()=>{console.log("[AvatarSDK] Init message sent, continuing..."),e()},2e3)})}handleWebSocketMessage(e){var t,n;try{const o="string"==typeof e?JSON.parse(e):e;switch(console.log("[AvatarSDK] WebSocket message received:",o.type),this.eventBus.emit("message",o),o.type){case"session_started":console.log("[AvatarSDK] Session started");break;case"render_data":break;case"error":this.handleError(new i((null===(t=o.payload)||void 0===t?void 0:t.code)||s.UNKNOWN_ERROR,(null===(n=o.payload)||void 0===n?void 0:n.message)||"Unknown error"))}}catch(e){console.error("[AvatarSDK] Failed to handle WebSocket message:",e)}}async start(){try{console.log("[AvatarSDK] Starting SDK..."),await this.lifecycleManager.start(),console.log("[AvatarSDK] SDK started successfully")}catch(e){throw console.error("[AvatarSDK] Start failed:",e),e}}async pause(){try{console.log("[AvatarSDK] Pausing SDK..."),await this.lifecycleManager.pause(),console.log("[AvatarSDK] SDK paused successfully")}catch(e){throw console.error("[AvatarSDK] Pause failed:",e),e}}async resume(){try{console.log("[AvatarSDK] Resuming SDK..."),await this.lifecycleManager.resume(),console.log("[AvatarSDK] SDK resumed successfully")}catch(e){throw console.error("[AvatarSDK] Resume failed:",e),e}}async destroy(){try{console.log("[AvatarSDK] Destroying SDK..."),await this.lifecycleManager.destroy();for(const[e,t]of this.modules)t.destroy&&await t.destroy();this.modules.clear();for(const[e,t]of this.plugins)t.uninstall&&t.uninstall();this.plugins.clear(),this.eventBus.emit(o.DESTROY),this.eventBus.destroy(),console.log("[AvatarSDK] SDK destroyed successfully")}catch(e){throw console.error("[AvatarSDK] Destroy failed:",e),e}}async speak(e,t){if(!this.stateManager.canOperate())throw new i(s.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Speaking:",e)}async playAnimation(e,t){if(!this.stateManager.canOperate())throw new i(s.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Playing animation:",e)}async stopAnimation(){console.log("[AvatarSDK] Stopping animation")}getState(){return this.stateManager.getState()}getStatus(){return this.stateManager.getConnectionStatus()}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}use(e){this.plugins.has(e.name)?console.warn(`[AvatarSDK] Plugin ${e.name} already installed`):(console.log(`[AvatarSDK] Installing plugin: ${e.name} v${e.version}`),e.install(this),this.plugins.set(e.name,e))}registerModule(e,t){this.modules.has(e)?console.warn(`[AvatarSDK] Module ${e} already registered`):(console.log(`[AvatarSDK] Registering module: ${e}`),this.modules.set(e,t))}getModule(e){return this.modules.get(e)}getConfig(){return{...this.config}}getEventBus(){return this.eventBus}getStateManager(){return this.stateManager}getLifecycleManager(){return this.lifecycleManager}validateConfig(e){if(!e.appId)throw new i(s.CONFIG_INVALID,"appId is required");if(!e.appSecret)throw new i(s.CONFIG_INVALID,"appSecret is required");if(!e.serverUrl)throw new i(s.CONFIG_INVALID,"serverUrl is required");if(!e.canvas||!e.canvas.id)throw new i(s.CONFIG_INVALID,"canvas.id is required")}mergeDefaultConfig(e){return{...e,render:{quality:"auto",fps:30,enableOptimization:!0,backgroundColor:"#000000",antialias:!0,...e.render},audio:{enabled:!0,volume:1,autoPlay:!0,format:"mp3",...e.audio},network:{timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...e.network},cache:{enabled:!0,maxSize:50,ttl:36e5,strategy:"hybrid",...e.cache},logger:{level:"info",upload:!1,console:!0,...e.logger}}}handleError(e){console.error("[AvatarSDK] Error:",e),this.eventBus.emit(o.ERROR,e),this.config.onError&&this.config.onError(e)}}class E{constructor(e){this.canvas=null,this.context=null,this.canvasId=e.id,this.canvasType=e.type||"webgl",this.width=e.width||375,this.height=e.height||667,this.pixelRatio=e.pixelRatio||wx.getSystemInfoSync().pixelRatio||2}async init(){try{if(console.log("[CanvasAdapter] Initializing canvas:",this.canvasId),this.canvas=await this.getCanvasNode(),!this.canvas)throw new i(s.CANVAS_NOT_FOUND,`Canvas not found: ${this.canvasId}`);if(this.setSize(this.width,this.height),"webgl"===this.canvasType?this.context=this.createWebGLContext():this.context=this.canvas.getContext("2d"),!this.context)throw new i(s.WEBGL_NOT_SUPPORT,"Failed to create canvas context");console.log("[CanvasAdapter] Canvas initialized successfully")}catch(e){throw console.error("[CanvasAdapter] Initialization failed:",e),e}}async getCanvasNode(){return new Promise((e,t)=>{wx.createSelectorQuery().select(`#${this.canvasId}`).fields({node:!0,size:!0}).exec(n=>{n&&n[0]&&n[0].node?e(n[0].node):t(new i(s.CANVAS_NOT_FOUND,`Canvas node not found: ${this.canvasId}`))})})}createWebGLContext(){if(!this.canvas)return null;try{const e=this.canvas.getContext("webgl");if(!e)throw new i(s.WEBGL_NOT_SUPPORT,"WebGL not supported");return e.viewport(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),console.log("[CanvasAdapter] WebGL context created"),e}catch(e){throw console.error("[CanvasAdapter] Failed to create WebGL context:",e),e}}setSize(e,t){if(this.canvas&&(this.width=e,this.height=t,this.canvas.width=e*this.pixelRatio,this.canvas.height=t*this.pixelRatio,console.log(`[CanvasAdapter] Canvas size set to ${e}x${t} (${this.canvas.width}x${this.canvas.height})`),this.context&&"webgl"===this.canvasType)){this.context.viewport(0,0,this.canvas.width,this.canvas.height)}}clear(e){if(this.context)if("webgl"===this.canvasType){const t=this.context,s=this.parseColor(e||"#000000");t.clearColor(s[0],s[1],s[2],s[3]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}else{const t=this.context;t.clearRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio),e&&(t.fillStyle=e,t.fillRect(0,0,this.width*this.pixelRatio,this.height*this.pixelRatio))}}getCanvas(){return this.canvas}getContext(){return this.context}getWebGLContext(){return"webgl"===this.canvasType?this.context:null}get2DContext(){return"2d"===this.canvasType?this.context:null}getSize(){return{width:this.width,height:this.height}}getPixelRatio(){return this.pixelRatio}async toDataURL(e="image/png",t=1){if(!this.canvas)throw new i(s.CANVAS_NOT_FOUND,"Canvas not initialized");return new Promise((n,o)=>{wx.canvasToTempFilePath({canvas:this.canvas,fileType:e.replace("image/",""),quality:t,success:e=>{n(e.tempFilePath)},fail:e=>{o(new i(s.RENDER_FAILED,"Failed to export canvas",e))}})})}parseColor(e){let t=0,s=0,n=0,o=1;if(e.startsWith("#")){const i=e.slice(1);6===i.length?(t=parseInt(i.slice(0,2),16)/255,s=parseInt(i.slice(2,4),16)/255,n=parseInt(i.slice(4,6),16)/255):8===i.length&&(t=parseInt(i.slice(0,2),16)/255,s=parseInt(i.slice(2,4),16)/255,n=parseInt(i.slice(4,6),16)/255,o=parseInt(i.slice(6,8),16)/255)}return[t,s,n,o]}destroy(){this.context=null,this.canvas=null,console.log("[CanvasAdapter] Canvas adapter destroyed")}}!function(e){e[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED"}(l||(l={}));class f extends h{constructor(e,t={}){super(),this.socket=null,this.state=l.CLOSED,this.reconnectTimer=null,this.heartbeatTimer=null,this.reconnectAttempts=0,this.messageQueue=[],this.isManualClose=!1,this.url=e,this.config={timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...t}}async connect(){if(this.state!==l.OPEN&&this.state!==l.CONNECTING)return new Promise((e,t)=>{try{console.log("[WebSocketAdapter] Connecting to:",this.url),this.state=l.CONNECTING,this.isManualClose=!1,this.socket=wx.connectSocket({url:this.url,timeout:this.config.timeout,success:()=>{console.log("[WebSocketAdapter] Socket created")},fail:e=>{console.error("[WebSocketAdapter] Failed to create socket:",e),this.state=l.CLOSED,t(new i(s.WEBSOCKET_ERROR,"Failed to create WebSocket",e))}}),this.setupSocketListeners(e,t);const n=setTimeout(()=>{this.state===l.CONNECTING&&(this.close(),t(new i(s.CONNECT_TIMEOUT,"WebSocket connection timeout")))},this.config.timeout);this.once("open",()=>{clearTimeout(n)})}catch(e){this.state=l.CLOSED,t(new i(s.WEBSOCKET_ERROR,"Failed to connect WebSocket",e))}});console.warn("[WebSocketAdapter] Already connected or connecting")}setupSocketListeners(e,t){this.socket&&(this.socket.onOpen(()=>{console.log("[WebSocketAdapter] Connection opened"),this.state=l.OPEN,this.reconnectAttempts=0,this.flushMessageQueue(),this.startHeartbeat(),this.emit("open"),e()}),this.socket.onMessage(e=>{try{const t="string"==typeof e.data?JSON.parse(e.data):e.data;this.emit("message",t)}catch(e){console.error("[WebSocketAdapter] Failed to parse message:",e),this.emit("error",new i(s.WEBSOCKET_ERROR,"Failed to parse message",e))}}),this.socket.onError(e=>{console.error("[WebSocketAdapter] Connection error:",e),this.emit("error",new i(s.WEBSOCKET_ERROR,"WebSocket error",e))}),this.socket.onClose(e=>{console.log("[WebSocketAdapter] Connection closed:",e.code,e.reason),this.state=l.CLOSED,this.stopHeartbeat(),this.emit("close",{code:e.code,reason:e.reason}),!this.isManualClose&&this.config.autoReconnect&&this.scheduleReconnect()}))}send(e){if(this.state!==l.OPEN)return console.warn("[WebSocketAdapter] Connection not open, queueing message"),void this.messageQueue.push(e);try{const t="string"==typeof e?e:JSON.stringify(e);this.socket.send({data:t,success:()=>{console.log("[WebSocketAdapter] Message sent")},fail:e=>{console.error("[WebSocketAdapter] Failed to send message:",e),this.emit("error",new i(s.WEBSOCKET_ERROR,"Failed to send message",e))}})}catch(e){console.error("[WebSocketAdapter] Failed to serialize message:",e),this.emit("error",new i(s.WEBSOCKET_ERROR,"Failed to serialize message",e))}}close(e=1e3,t="Normal closure"){console.log("[WebSocketAdapter] Closing connection"),this.isManualClose=!0,this.stopHeartbeat(),this.stopReconnect(),this.socket&&this.state!==l.CLOSED&&(this.state=l.CLOSING,this.socket.close({code:e,reason:t,success:()=>{console.log("[WebSocketAdapter] Connection closed successfully")},fail:e=>{console.error("[WebSocketAdapter] Failed to close connection:",e)}})),this.socket=null,this.state=l.CLOSED}flushMessageQueue(){if(0!==this.messageQueue.length)for(console.log(`[WebSocketAdapter] Flushing ${this.messageQueue.length} queued messages`);this.messageQueue.length>0;){const e=this.messageQueue.shift();this.send(e)}}startHeartbeat(){this.config.heartbeatInterval&&!this.heartbeatTimer&&(console.log("[WebSocketAdapter] Starting heartbeat"),this.heartbeatTimer=setInterval(()=>{this.state===l.OPEN&&this.send({type:"ping",timestamp:Date.now()})},this.config.heartbeatInterval))}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,console.log("[WebSocketAdapter] Heartbeat stopped"))}scheduleReconnect(){if(this.reconnectTimer||this.isManualClose)return;if(this.reconnectAttempts>=this.config.retryTimes)return console.error("[WebSocketAdapter] Max reconnect attempts reached"),void this.emit("error",new i(s.RECONNECT_FAILED,"Max reconnect attempts reached"));this.reconnectAttempts++;const e=this.config.reconnectDelay*this.reconnectAttempts;console.log(`[WebSocketAdapter] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.config.retryTimes})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.connect().catch(e=>{console.error("[WebSocketAdapter] Reconnect failed:",e)})},e)}stopReconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null,console.log("[WebSocketAdapter] Reconnect stopped"))}getState(){return this.state}isConnected(){return this.state===l.OPEN}destroy(){this.close(),this.removeAllListeners(),this.messageQueue=[],console.log("[WebSocketAdapter] WebSocket adapter destroyed")}}class p{constructor(e={}){this.logs=[],this.maxLogs=1e3,this.levelPriority={debug:0,info:1,warn:2,error:3},this.config={level:"info",upload:!1,console:!0,...e}}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}log(e,t,s){if(this.levelPriority[e]<this.levelPriority[this.config.level])return;const n={level:e,message:t,data:s,timestamp:Date.now()};"error"===e&&s instanceof Error&&(n.stack=s.stack),this.logs.push(n),this.logs.length>this.maxLogs&&this.logs.shift(),this.config.console&&this.consoleLog(n),this.config.upload&&"error"===e&&this.uploadLog(n)}consoleLog(e){const t=`${`[${this.formatTime(e.timestamp)}] [${e.level.toUpperCase()}]`} ${e.message}`;switch(e.level){case"debug":console.debug(t,e.data||"");break;case"info":console.log(t,e.data||"");break;case"warn":console.warn(t,e.data||"");break;case"error":console.error(t,e.data||""),e.stack&&console.error(e.stack)}}uploadLog(e){this.config.uploadUrl&&wx.request({url:this.config.uploadUrl,method:"POST",data:e,fail:e=>{console.error("[Logger] Failed to upload log:",e)}})}getLogs(e){return e?this.logs.filter(t=>t.level===e):[...this.logs]}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}formatTime(e){const t=new Date(e);return`${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}.${String(t.getMilliseconds()).padStart(3,"0")}`}setLevel(e){this.config.level=e}setUpload(e){this.config.upload=e}setUploadUrl(e){this.config.uploadUrl=e}}const v=new p;export{S as AvatarSDK,E as CanvasAdapter,t as ConnectionStatus,s as ErrorCode,g as EventBus,o as EventType,d as LifecycleManager,p as Logger,n as ResourceType,i as SDKError,e as SDKState,u as StateManager,f as WebSocketAdapter,S as default,v as logger};
//# sourceMappingURL=index.esm.js.map
