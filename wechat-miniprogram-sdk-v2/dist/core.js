!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XmovAvatarMPCore={})}(this,function(e){"use strict";var t,s,n,a,i;!function(e){e.UNINITIALIZED="uninitialized",e.INITIALIZING="initializing",e.INITIALIZED="initialized",e.CONNECTING="connecting",e.CONNECTED="connected",e.RUNNING="running",e.PAUSED="paused",e.DISCONNECTED="disconnected",e.DESTROYED="destroyed",e.ERROR="error"}(t||(t={})),function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.FAILED="failed"}(s||(s={})),function(e){e[e.INIT_FAILED=1e3]="INIT_FAILED",e[e.CONFIG_INVALID=1001]="CONFIG_INVALID",e[e.CANVAS_NOT_FOUND=1002]="CANVAS_NOT_FOUND",e[e.WEBGL_NOT_SUPPORT=1003]="WEBGL_NOT_SUPPORT",e[e.CONNECT_FAILED=2e3]="CONNECT_FAILED",e[e.CONNECT_TIMEOUT=2001]="CONNECT_TIMEOUT",e[e.DISCONNECT=2002]="DISCONNECT",e[e.RECONNECT_FAILED=2003]="RECONNECT_FAILED",e[e.RENDER_FAILED=3e3]="RENDER_FAILED",e[e.CONTEXT_LOST=3001]="CONTEXT_LOST",e[e.FRAME_DROP=3002]="FRAME_DROP",e[e.AUDIO_FAILED=4e3]="AUDIO_FAILED",e[e.AUDIO_NOT_SUPPORT=4001]="AUDIO_NOT_SUPPORT",e[e.AUDIO_DECODE_ERROR=4002]="AUDIO_DECODE_ERROR",e[e.RESOURCE_LOAD_FAILED=5e3]="RESOURCE_LOAD_FAILED",e[e.RESOURCE_NOT_FOUND=5001]="RESOURCE_NOT_FOUND",e[e.RESOURCE_TIMEOUT=5002]="RESOURCE_TIMEOUT",e[e.RESOURCE_PARSE_ERROR=5003]="RESOURCE_PARSE_ERROR",e[e.NETWORK_ERROR=6e3]="NETWORK_ERROR",e[e.REQUEST_TIMEOUT=6001]="REQUEST_TIMEOUT",e[e.REQUEST_FAILED=6002]="REQUEST_FAILED",e[e.WEBSOCKET_ERROR=6003]="WEBSOCKET_ERROR",e[e.AUTHENTICATION_FAILED=7e3]="AUTHENTICATION_FAILED",e[e.PERMISSION_DENIED=7001]="PERMISSION_DENIED",e[e.QUOTA_EXCEEDED=7002]="QUOTA_EXCEEDED",e[e.UNKNOWN_ERROR=9999]="UNKNOWN_ERROR"}(n||(n={}));class o extends Error{constructor(e,t,s){super(t),this.name="SDKError",this.code=e,this.details=s,this.timestamp=Date.now()}}function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}!function(e){e.MODEL="model",e.TEXTURE="texture",e.AUDIO="audio",e.ANIMATION="animation",e.CONFIG="config",e.OTHER="other"}(a||(a={})),function(e){e.READY="ready",e.DESTROY="destroy",e.CONNECTED="connected",e.DISCONNECTED="disconnected",e.RECONNECTING="reconnecting",e.RENDER_START="render-start",e.RENDER_END="render-end",e.RENDER_ERROR="render-error",e.AUDIO_START="audio-start",e.AUDIO_END="audio-end",e.AUDIO_ERROR="audio-error",e.ANIMATION_START="animation-start",e.ANIMATION_END="animation-end",e.ANIMATION_LOOP="animation-loop",e.RESOURCE_LOADING="resource-loading",e.RESOURCE_LOADED="resource-loaded",e.RESOURCE_ERROR="resource-error",e.STATE_CHANGE="state-change",e.PERFORMANCE="performance",e.ERROR="error"}(i||(i={}));var c={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function n(){}function a(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,n,i,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var r=new a(n,i||e,o),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],r]:e._events[c].push(r):(e._events[c]=r,e._eventsCount++),e}function o(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function r(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),r.prototype.eventNames=function(){var e,n,a=[];if(0===this._eventsCount)return a;for(n in e=this._events)t.call(e,n)&&a.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},r.prototype.listeners=function(e){var t=s?s+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,i=n.length,o=new Array(i);a<i;a++)o[a]=n[a].fn;return o},r.prototype.listenerCount=function(e){var t=s?s+e:e,n=this._events[t];return n?n.fn?1:n.length:0},r.prototype.emit=function(e,t,n,a,i,o){var r=s?s+e:e;if(!this._events[r])return!1;var c,l,h=this._events[r],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,n),!0;case 4:return h.fn.call(h.context,t,n,a),!0;case 5:return h.fn.call(h.context,t,n,a,i),!0;case 6:return h.fn.call(h.context,t,n,a,i,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var g,E=h.length;for(l=0;l<E;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),u){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,n);break;case 4:h[l].fn.call(h[l].context,t,n,a);break;default:if(!c)for(g=1,c=new Array(u-1);g<u;g++)c[g-1]=arguments[g];h[l].fn.apply(h[l].context,c)}}return!0},r.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},r.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},r.prototype.removeListener=function(e,t,n,a){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var r=this._events[i];if(r.fn)r.fn!==t||a&&!r.once||n&&r.context!==n||o(this,i);else{for(var c=0,l=[],h=r.length;c<h;c++)(r[c].fn!==t||a&&!r[c].once||n&&r[c].context!==n)&&l.push(r[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},r.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},r.prototype.off=r.prototype.removeListener,r.prototype.addListener=r.prototype.on,r.prefixed=s,r.EventEmitter=r,e.exports=r}(c);var l,h=r(c.exports);class u{constructor(e=100){this.emitter=new h,this.eventHistory=new Map,this.maxHistorySize=e}on(e,t,s){this.emitter.on(e,t,s)}once(e,t,s){this.emitter.once(e,t,s)}off(e,t,s){t?this.emitter.off(e,t,s):this.emitter.removeAllListeners(e)}emit(e,...t){this.recordEvent(e,t),this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}eventNames(){return this.emitter.eventNames()}removeAllListeners(e){e?this.emitter.removeAllListeners(e):this.emitter.removeAllListeners()}recordEvent(e,t){this.eventHistory.has(e)||this.eventHistory.set(e,[]);const s=this.eventHistory.get(e);s.push({timestamp:Date.now(),args:t}),s.length>this.maxHistorySize&&s.shift()}getEventHistory(e){return this.eventHistory.get(e)||[]}clearEventHistory(e){e?this.eventHistory.delete(e):this.eventHistory.clear()}destroy(){this.removeAllListeners(),this.eventHistory.clear()}}class g{constructor(e,n=50){this.eventBus=e,this.sdkState=t.UNINITIALIZED,this.connectionStatus=s.DISCONNECTED,this.stateHistory=[],this.maxHistorySize=n}getState(){return this.sdkState}setState(e){if(this.sdkState===e)return;const t=this.sdkState;this.sdkState=e,this.recordStateHistory(e),this.eventBus.emit(i.STATE_CHANGE,{previous:t,current:e,timestamp:Date.now()}),console.log(`[StateManager] State changed: ${t} -> ${e}`)}getConnectionStatus(){return this.connectionStatus}setConnectionStatus(e){if(this.connectionStatus===e)return;const t=this.connectionStatus;switch(this.connectionStatus=e,console.log(`[StateManager] Connection status changed: ${t} -> ${e}`),e){case s.CONNECTED:this.eventBus.emit(i.CONNECTED);break;case s.DISCONNECTED:this.eventBus.emit(i.DISCONNECTED);break;case s.RECONNECTING:this.eventBus.emit(i.RECONNECTING)}}canOperate(){return this.sdkState===t.RUNNING||this.sdkState===t.PAUSED||this.sdkState===t.CONNECTED}isInitialized(){return this.sdkState!==t.UNINITIALIZED}isConnected(){return this.connectionStatus===s.CONNECTED}isRunning(){return this.sdkState===t.RUNNING}isDestroyed(){return this.sdkState===t.DESTROYED}recordStateHistory(e){this.stateHistory.push({state:e,timestamp:Date.now()}),this.stateHistory.length>this.maxHistorySize&&this.stateHistory.shift()}getStateHistory(){return[...this.stateHistory]}getStateDuration(){if(0===this.stateHistory.length)return 0;const e=this.stateHistory[this.stateHistory.length-1];return Date.now()-e.timestamp}reset(){this.sdkState=t.UNINITIALIZED,this.connectionStatus=s.DISCONNECTED,this.stateHistory=[]}destroy(){this.setState(t.DESTROYED),this.stateHistory=[]}}!function(e){e.INIT="init",e.START="start",e.PAUSE="pause",e.RESUME="resume",e.DESTROY="destroy"}(l||(l={}));class E{constructor(e,t){this.eventBus=e,this.stateManager=t,this.hooks=new Map,this.isPageVisible=!0,this.setupMiniProgramLifecycle()}registerHooks(e,t){this.hooks.set(e,t),console.log(`[LifecycleManager] Registered hooks for module: ${e}`)}unregisterHooks(e){this.hooks.delete(e),console.log(`[LifecycleManager] Unregistered hooks for module: ${e}`)}async init(){if(this.stateManager.isInitialized())throw new o(n.INIT_FAILED,"SDK already initialized");console.log("[LifecycleManager] Initializing..."),this.stateManager.setState(t.INITIALIZING);try{await this.executePhase(l.INIT),this.stateManager.setState(t.INITIALIZED),console.log("[LifecycleManager] Initialization completed")}catch(e){throw this.stateManager.setState(t.ERROR),new o(n.INIT_FAILED,"Initialization failed",e)}}async start(){if(!this.stateManager.isInitialized())throw new o(n.INIT_FAILED,"SDK not initialized");if(this.stateManager.isRunning())console.warn("[LifecycleManager] SDK already running");else{console.log("[LifecycleManager] Starting...");try{await this.executePhase(l.START),this.stateManager.setState(t.RUNNING),console.log("[LifecycleManager] Started successfully")}catch(e){throw this.stateManager.setState(t.ERROR),new o(n.INIT_FAILED,"Start failed",e)}}}async pause(){if(this.stateManager.isRunning()){console.log("[LifecycleManager] Pausing...");try{await this.executePhase(l.PAUSE),this.stateManager.setState(t.PAUSED),console.log("[LifecycleManager] Paused successfully")}catch(e){console.error("[LifecycleManager] Pause failed:",e)}}else console.warn("[LifecycleManager] SDK not running")}async resume(){if(this.stateManager.getState()===t.PAUSED){console.log("[LifecycleManager] Resuming...");try{await this.executePhase(l.RESUME),this.stateManager.setState(t.RUNNING),console.log("[LifecycleManager] Resumed successfully")}catch(e){console.error("[LifecycleManager] Resume failed:",e)}}else console.warn("[LifecycleManager] SDK not paused")}async destroy(){if(this.stateManager.isDestroyed())console.warn("[LifecycleManager] SDK already destroyed");else{console.log("[LifecycleManager] Destroying...");try{await this.executePhase(l.DESTROY),this.stateManager.destroy(),this.hooks.clear(),console.log("[LifecycleManager] Destroyed successfully")}catch(e){console.error("[LifecycleManager] Destroy failed:",e)}}}async executePhase(e){const t=`on${e.charAt(0).toUpperCase()+e.slice(1)}`,s=[];for(const[e,n]of this.hooks){const a=n[t];a&&(console.log(`[LifecycleManager] Executing ${t} for ${e}`),s.push(a().catch(s=>{throw console.error(`[LifecycleManager] ${t} failed for ${e}:`,s),s})))}await Promise.all(s)}setupMiniProgramLifecycle(){var e,s;"undefined"!=typeof wx&&(null===(e=wx.onAppShow)||void 0===e||e.call(wx,()=>{console.log("[LifecycleManager] App show"),this.isPageVisible=!0,this.stateManager.getState()===t.PAUSED&&this.resume().catch(e=>{console.error("[LifecycleManager] Auto resume failed:",e)})}),null===(s=wx.onAppHide)||void 0===s||s.call(wx,()=>{console.log("[LifecycleManager] App hide"),this.isPageVisible=!1,this.stateManager.isRunning()&&this.pause().catch(e=>{console.error("[LifecycleManager] Auto pause failed:",e)})}))}getPageVisibility(){return this.isPageVisible}}e.AvatarSDK=class{constructor(e){this.webSocket=null,this.sessionId="",this.canvas=null,this.gl=null,this.validateConfig(e),this.config=this.mergeDefaultConfig(e),this.eventBus=new u,this.stateManager=new g(this.eventBus),this.lifecycleManager=new E(this.eventBus,this.stateManager),this.modules=new Map,this.plugins=new Map,console.log("[AvatarSDK] SDK instance created")}async init(){try{console.log("[AvatarSDK] Initializing SDK..."),this.stateManager.setState(t.INITIALIZING),console.log("[AvatarSDK] Step 1: Getting canvas node..."),await this.initCanvas(),console.log("[AvatarSDK] Canvas node obtained"),console.log("[AvatarSDK] Step 2: Creating WebGL context..."),await this.initWebGL(),console.log("[AvatarSDK] WebGL context created"),console.log("[AvatarSDK] Step 3: Connecting to WebSocket server..."),await this.connectWebSocket(),console.log("[AvatarSDK] WebSocket connected"),console.log("[AvatarSDK] Step 4: Sending init message..."),await this.sendInitMessage(),console.log("[AvatarSDK] Init message sent"),await this.lifecycleManager.init(),this.stateManager.setState(t.INITIALIZED),this.eventBus.emit(i.READY),this.config.onReady&&this.config.onReady(),console.log("[AvatarSDK] SDK initialized successfully")}catch(e){console.error("[AvatarSDK] Initialization failed:",e),this.stateManager.setState(t.ERROR);const s=e instanceof o?e:new o(n.INIT_FAILED,"Initialization failed",e);throw this.handleError(s),s}}async initCanvas(){return new Promise((e,t)=>{wx.createSelectorQuery().select(`#${this.config.canvas.id}`).fields({node:!0,size:!0}).exec(s=>{if(!s||!s[0]||!s[0].node)return void t(new o(n.CANVAS_NOT_FOUND,`Canvas not found: ${this.config.canvas.id}`));this.canvas=s[0].node;const a=wx.getSystemInfoSync().pixelRatio;this.canvas.width=s[0].width*a,this.canvas.height=s[0].height*a,console.log(`[AvatarSDK] Canvas size: ${this.canvas.width}x${this.canvas.height}`),e()})})}async initWebGL(){var e;if(!this.canvas)throw new o(n.CANVAS_NOT_FOUND,"Canvas not initialized");if(this.gl=this.canvas.getContext("webgl",{antialias:!1!==(null===(e=this.config.render)||void 0===e?void 0:e.antialias),preserveDrawingBuffer:!0}),!this.gl)throw new o(n.WEBGL_NOT_SUPPORT,"Failed to create WebGL context");this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),console.log("[AvatarSDK] WebGL context created successfully")}async connectWebSocket(){const e=this.buildWebSocketUrl();return console.log("[AvatarSDK] Connecting to:",e),new Promise((t,a)=>{var r;const c=setTimeout(()=>{a(new o(n.CONNECT_TIMEOUT,"WebSocket connection timeout"))},(null===(r=this.config.network)||void 0===r?void 0:r.timeout)||1e4);this.webSocket=wx.connectSocket({url:e,success:()=>{console.log("[AvatarSDK] WebSocket created")},fail:e=>{clearTimeout(c),a(new o(n.WEBSOCKET_ERROR,"Failed to create WebSocket",e))}}),this.webSocket.onOpen(()=>{clearTimeout(c),console.log("[AvatarSDK] WebSocket connection opened"),this.stateManager.setConnectionStatus(s.CONNECTED),this.eventBus.emit(i.CONNECTED),t()}),this.webSocket.onMessage(e=>{this.handleWebSocketMessage(e.data)}),this.webSocket.onError(e=>{console.error("[AvatarSDK] WebSocket error:",e),this.handleError(new o(n.WEBSOCKET_ERROR,"WebSocket error",e))}),this.webSocket.onClose(e=>{console.log("[AvatarSDK] WebSocket closed:",e.code,e.reason),this.stateManager.setConnectionStatus(s.DISCONNECTED),this.eventBus.emit(i.DISCONNECTED)})})}buildWebSocketUrl(){const e=new URL(this.config.serverUrl);return e.searchParams.set("appId",this.config.appId),e.searchParams.set("appSecret",this.config.appSecret),e.searchParams.set("sdkVersion","2.0.0"),e.searchParams.set("platform","miniprogram"),e.toString()}async sendInitMessage(){var e,t;if(!this.webSocket)throw new o(n.WEBSOCKET_ERROR,"WebSocket not connected");this.sessionId="session_"+Date.now().toString(36)+"_"+Math.random().toString(36).substr(2,9);const s={type:"init_session",sessionId:this.sessionId,canvasInfo:{width:(null===(e=this.canvas)||void 0===e?void 0:e.width)||0,height:(null===(t=this.canvas)||void 0===t?void 0:t.height)||0},userAgent:"miniprogram",sdkVersion:"2.0.0",timestamp:Date.now()};return this.webSocket.send({data:JSON.stringify(s)}),console.log("[AvatarSDK] Init message sent:",s),new Promise(e=>{setTimeout(()=>{console.log("[AvatarSDK] Init message sent, continuing..."),e()},2e3)})}handleWebSocketMessage(e){var t,s;try{const a="string"==typeof e?JSON.parse(e):e;switch(console.log("[AvatarSDK] WebSocket message received:",a.type),this.eventBus.emit("message",a),a.type){case"session_started":console.log("[AvatarSDK] Session started");break;case"render_data":break;case"error":this.handleError(new o((null===(t=a.payload)||void 0===t?void 0:t.code)||n.UNKNOWN_ERROR,(null===(s=a.payload)||void 0===s?void 0:s.message)||"Unknown error"))}}catch(e){console.error("[AvatarSDK] Failed to handle WebSocket message:",e)}}async start(){try{console.log("[AvatarSDK] Starting SDK..."),await this.lifecycleManager.start(),console.log("[AvatarSDK] SDK started successfully")}catch(e){throw console.error("[AvatarSDK] Start failed:",e),e}}async pause(){try{console.log("[AvatarSDK] Pausing SDK..."),await this.lifecycleManager.pause(),console.log("[AvatarSDK] SDK paused successfully")}catch(e){throw console.error("[AvatarSDK] Pause failed:",e),e}}async resume(){try{console.log("[AvatarSDK] Resuming SDK..."),await this.lifecycleManager.resume(),console.log("[AvatarSDK] SDK resumed successfully")}catch(e){throw console.error("[AvatarSDK] Resume failed:",e),e}}async destroy(){try{console.log("[AvatarSDK] Destroying SDK..."),await this.lifecycleManager.destroy();for(const[e,t]of this.modules)t.destroy&&await t.destroy();this.modules.clear();for(const[e,t]of this.plugins)t.uninstall&&t.uninstall();this.plugins.clear(),this.eventBus.emit(i.DESTROY),this.eventBus.destroy(),console.log("[AvatarSDK] SDK destroyed successfully")}catch(e){throw console.error("[AvatarSDK] Destroy failed:",e),e}}async speak(e,t){if(!this.stateManager.canOperate())throw new o(n.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Speaking:",e)}async playAnimation(e,t){if(!this.stateManager.canOperate())throw new o(n.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Playing animation:",e)}async stopAnimation(){console.log("[AvatarSDK] Stopping animation")}getState(){return this.stateManager.getState()}getStatus(){return this.stateManager.getConnectionStatus()}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}use(e){this.plugins.has(e.name)?console.warn(`[AvatarSDK] Plugin ${e.name} already installed`):(console.log(`[AvatarSDK] Installing plugin: ${e.name} v${e.version}`),e.install(this),this.plugins.set(e.name,e))}registerModule(e,t){this.modules.has(e)?console.warn(`[AvatarSDK] Module ${e} already registered`):(console.log(`[AvatarSDK] Registering module: ${e}`),this.modules.set(e,t))}getModule(e){return this.modules.get(e)}getConfig(){return{...this.config}}getEventBus(){return this.eventBus}getStateManager(){return this.stateManager}getLifecycleManager(){return this.lifecycleManager}validateConfig(e){if(!e.appId)throw new o(n.CONFIG_INVALID,"appId is required");if(!e.appSecret)throw new o(n.CONFIG_INVALID,"appSecret is required");if(!e.serverUrl)throw new o(n.CONFIG_INVALID,"serverUrl is required");if(!e.canvas||!e.canvas.id)throw new o(n.CONFIG_INVALID,"canvas.id is required")}mergeDefaultConfig(e){return{...e,render:{quality:"auto",fps:30,enableOptimization:!0,backgroundColor:"#000000",antialias:!0,...e.render},audio:{enabled:!0,volume:1,autoPlay:!0,format:"mp3",...e.audio},network:{timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...e.network},cache:{enabled:!0,maxSize:50,ttl:36e5,strategy:"hybrid",...e.cache},logger:{level:"info",upload:!1,console:!0,...e.logger}}}handleError(e){console.error("[AvatarSDK] Error:",e),this.eventBus.emit(i.ERROR,e),this.config.onError&&this.config.onError(e)}},e.EventBus=u,e.LifecycleManager=E,e.StateManager=g});
//# sourceMappingURL=core.js.map
