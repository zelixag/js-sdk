!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).XmovAvatarMPCore={})}(this,function(e){"use strict";var t,n,s,i,a;!function(e){e.UNINITIALIZED="uninitialized",e.INITIALIZING="initializing",e.INITIALIZED="initialized",e.CONNECTING="connecting",e.CONNECTED="connected",e.RUNNING="running",e.PAUSED="paused",e.DISCONNECTED="disconnected",e.DESTROYED="destroyed",e.ERROR="error"}(t||(t={})),function(e){e.DISCONNECTED="disconnected",e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.FAILED="failed"}(n||(n={})),function(e){e[e.INIT_FAILED=1e3]="INIT_FAILED",e[e.CONFIG_INVALID=1001]="CONFIG_INVALID",e[e.CANVAS_NOT_FOUND=1002]="CANVAS_NOT_FOUND",e[e.WEBGL_NOT_SUPPORT=1003]="WEBGL_NOT_SUPPORT",e[e.CONNECT_FAILED=2e3]="CONNECT_FAILED",e[e.CONNECT_TIMEOUT=2001]="CONNECT_TIMEOUT",e[e.DISCONNECT=2002]="DISCONNECT",e[e.RECONNECT_FAILED=2003]="RECONNECT_FAILED",e[e.RENDER_FAILED=3e3]="RENDER_FAILED",e[e.CONTEXT_LOST=3001]="CONTEXT_LOST",e[e.FRAME_DROP=3002]="FRAME_DROP",e[e.AUDIO_FAILED=4e3]="AUDIO_FAILED",e[e.AUDIO_NOT_SUPPORT=4001]="AUDIO_NOT_SUPPORT",e[e.AUDIO_DECODE_ERROR=4002]="AUDIO_DECODE_ERROR",e[e.RESOURCE_LOAD_FAILED=5e3]="RESOURCE_LOAD_FAILED",e[e.RESOURCE_NOT_FOUND=5001]="RESOURCE_NOT_FOUND",e[e.RESOURCE_TIMEOUT=5002]="RESOURCE_TIMEOUT",e[e.RESOURCE_PARSE_ERROR=5003]="RESOURCE_PARSE_ERROR",e[e.NETWORK_ERROR=6e3]="NETWORK_ERROR",e[e.REQUEST_TIMEOUT=6001]="REQUEST_TIMEOUT",e[e.REQUEST_FAILED=6002]="REQUEST_FAILED",e[e.WEBSOCKET_ERROR=6003]="WEBSOCKET_ERROR",e[e.AUTHENTICATION_FAILED=7e3]="AUTHENTICATION_FAILED",e[e.PERMISSION_DENIED=7001]="PERMISSION_DENIED",e[e.QUOTA_EXCEEDED=7002]="QUOTA_EXCEEDED",e[e.UNKNOWN_ERROR=9999]="UNKNOWN_ERROR"}(s||(s={}));class r extends Error{constructor(e,t,n){super(t),this.name="SDKError",this.code=e,this.details=n,this.timestamp=Date.now()}}function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}!function(e){e.MODEL="model",e.TEXTURE="texture",e.AUDIO="audio",e.ANIMATION="animation",e.CONFIG="config",e.OTHER="other"}(i||(i={})),function(e){e.READY="ready",e.DESTROY="destroy",e.CONNECTED="connected",e.DISCONNECTED="disconnected",e.RECONNECTING="reconnecting",e.RENDER_START="render-start",e.RENDER_END="render-end",e.RENDER_ERROR="render-error",e.AUDIO_START="audio-start",e.AUDIO_END="audio-end",e.AUDIO_ERROR="audio-error",e.ANIMATION_START="animation-start",e.ANIMATION_END="animation-end",e.ANIMATION_LOOP="animation-loop",e.RESOURCE_LOADING="resource-loading",e.RESOURCE_LOADED="resource-loaded",e.RESOURCE_ERROR="resource-error",e.STATE_CHANGE="state-change",e.PERFORMANCE="performance",e.ERROR="error"}(a||(a={}));var c={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function s(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,s,a,r){if("function"!=typeof s)throw new TypeError("The listener must be a function");var o=new i(s,a||e,r),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function r(e,t){0===--e._eventsCount?e._events=new s:delete e._events[t]}function o(){this._events=new s,this._eventsCount=0}Object.create&&(s.prototype=Object.create(null),(new s).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,s,i=[];if(0===this._eventsCount)return i;for(s in e=this._events)t.call(e,s)&&i.push(n?s.slice(1):s);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=n?n+e:e,s=this._events[t];if(!s)return[];if(s.fn)return[s.fn];for(var i=0,a=s.length,r=new Array(a);i<a;i++)r[i]=s[i].fn;return r},o.prototype.listenerCount=function(e){var t=n?n+e:e,s=this._events[t];return s?s.fn?1:s.length:0},o.prototype.emit=function(e,t,s,i,a,r){var o=n?n+e:e;if(!this._events[o])return!1;var c,l,h=this._events[o],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,s),!0;case 4:return h.fn.call(h.context,t,s,i),!0;case 5:return h.fn.call(h.context,t,s,i,a),!0;case 6:return h.fn.call(h.context,t,s,i,a,r),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var E,g=h.length;for(l=0;l<g;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),u){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,s);break;case 4:h[l].fn.call(h[l].context,t,s,i);break;default:if(!c)for(E=1,c=new Array(u-1);E<u;E++)c[E-1]=arguments[E];h[l].fn.apply(h[l].context,c)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,s,i){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return r(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||i&&!o.once||s&&o.context!==s||r(this,a);else{for(var c=0,l=[],h=o.length;c<h;c++)(o[c].fn!==t||i&&!o[c].once||s&&o[c].context!==s)&&l.push(o[c]);l.length?this._events[a]=1===l.length?l[0]:l:r(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&r(this,t)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(c);var l,h=o(c.exports);class u{constructor(e=100){this.emitter=new h,this.eventHistory=new Map,this.maxHistorySize=e}on(e,t,n){this.emitter.on(e,t,n)}once(e,t,n){this.emitter.once(e,t,n)}off(e,t,n){t?this.emitter.off(e,t,n):this.emitter.removeAllListeners(e)}emit(e,...t){this.recordEvent(e,t),this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}eventNames(){return this.emitter.eventNames()}removeAllListeners(e){e?this.emitter.removeAllListeners(e):this.emitter.removeAllListeners()}recordEvent(e,t){this.eventHistory.has(e)||this.eventHistory.set(e,[]);const n=this.eventHistory.get(e);n.push({timestamp:Date.now(),args:t}),n.length>this.maxHistorySize&&n.shift()}getEventHistory(e){return this.eventHistory.get(e)||[]}clearEventHistory(e){e?this.eventHistory.delete(e):this.eventHistory.clear()}destroy(){this.removeAllListeners(),this.eventHistory.clear()}}class E{constructor(e,s=50){this.eventBus=e,this.sdkState=t.UNINITIALIZED,this.connectionStatus=n.DISCONNECTED,this.stateHistory=[],this.maxHistorySize=s}getState(){return this.sdkState}setState(e){if(this.sdkState===e)return;const t=this.sdkState;this.sdkState=e,this.recordStateHistory(e),this.eventBus.emit(a.STATE_CHANGE,{previous:t,current:e,timestamp:Date.now()}),console.log(`[StateManager] State changed: ${t} -> ${e}`)}getConnectionStatus(){return this.connectionStatus}setConnectionStatus(e){if(this.connectionStatus===e)return;const t=this.connectionStatus;switch(this.connectionStatus=e,console.log(`[StateManager] Connection status changed: ${t} -> ${e}`),e){case n.CONNECTED:this.eventBus.emit(a.CONNECTED);break;case n.DISCONNECTED:this.eventBus.emit(a.DISCONNECTED);break;case n.RECONNECTING:this.eventBus.emit(a.RECONNECTING)}}canOperate(){return this.sdkState===t.RUNNING||this.sdkState===t.PAUSED||this.sdkState===t.CONNECTED}isInitialized(){return this.sdkState!==t.UNINITIALIZED}isConnected(){return this.connectionStatus===n.CONNECTED}isRunning(){return this.sdkState===t.RUNNING}isDestroyed(){return this.sdkState===t.DESTROYED}recordStateHistory(e){this.stateHistory.push({state:e,timestamp:Date.now()}),this.stateHistory.length>this.maxHistorySize&&this.stateHistory.shift()}getStateHistory(){return[...this.stateHistory]}getStateDuration(){if(0===this.stateHistory.length)return 0;const e=this.stateHistory[this.stateHistory.length-1];return Date.now()-e.timestamp}reset(){this.sdkState=t.UNINITIALIZED,this.connectionStatus=n.DISCONNECTED,this.stateHistory=[]}destroy(){this.setState(t.DESTROYED),this.stateHistory=[]}}!function(e){e.INIT="init",e.START="start",e.PAUSE="pause",e.RESUME="resume",e.DESTROY="destroy"}(l||(l={}));class g{constructor(e,t){this.eventBus=e,this.stateManager=t,this.hooks=new Map,this.isPageVisible=!0,this.setupMiniProgramLifecycle()}registerHooks(e,t){this.hooks.set(e,t),console.log(`[LifecycleManager] Registered hooks for module: ${e}`)}unregisterHooks(e){this.hooks.delete(e),console.log(`[LifecycleManager] Unregistered hooks for module: ${e}`)}async init(){if(this.stateManager.isInitialized())throw new r(s.INIT_FAILED,"SDK already initialized");console.log("[LifecycleManager] Initializing..."),this.stateManager.setState(t.INITIALIZING);try{await this.executePhase(l.INIT),this.stateManager.setState(t.INITIALIZED),console.log("[LifecycleManager] Initialization completed")}catch(e){throw this.stateManager.setState(t.ERROR),new r(s.INIT_FAILED,"Initialization failed",e)}}async start(){if(!this.stateManager.isInitialized())throw new r(s.INIT_FAILED,"SDK not initialized");if(this.stateManager.isRunning())console.warn("[LifecycleManager] SDK already running");else{console.log("[LifecycleManager] Starting...");try{await this.executePhase(l.START),this.stateManager.setState(t.RUNNING),console.log("[LifecycleManager] Started successfully")}catch(e){throw this.stateManager.setState(t.ERROR),new r(s.INIT_FAILED,"Start failed",e)}}}async pause(){if(this.stateManager.isRunning()){console.log("[LifecycleManager] Pausing...");try{await this.executePhase(l.PAUSE),this.stateManager.setState(t.PAUSED),console.log("[LifecycleManager] Paused successfully")}catch(e){console.error("[LifecycleManager] Pause failed:",e)}}else console.warn("[LifecycleManager] SDK not running")}async resume(){if(this.stateManager.getState()===t.PAUSED){console.log("[LifecycleManager] Resuming...");try{await this.executePhase(l.RESUME),this.stateManager.setState(t.RUNNING),console.log("[LifecycleManager] Resumed successfully")}catch(e){console.error("[LifecycleManager] Resume failed:",e)}}else console.warn("[LifecycleManager] SDK not paused")}async destroy(){if(this.stateManager.isDestroyed())console.warn("[LifecycleManager] SDK already destroyed");else{console.log("[LifecycleManager] Destroying...");try{await this.executePhase(l.DESTROY),this.stateManager.destroy(),this.hooks.clear(),console.log("[LifecycleManager] Destroyed successfully")}catch(e){console.error("[LifecycleManager] Destroy failed:",e)}}}async executePhase(e){const t=`on${e.charAt(0).toUpperCase()+e.slice(1)}`,n=[];for(const[e,s]of this.hooks){const i=s[t];i&&(console.log(`[LifecycleManager] Executing ${t} for ${e}`),n.push(i().catch(n=>{throw console.error(`[LifecycleManager] ${t} failed for ${e}:`,n),n})))}await Promise.all(n)}setupMiniProgramLifecycle(){var e,n;"undefined"!=typeof wx&&(null===(e=wx.onAppShow)||void 0===e||e.call(wx,()=>{console.log("[LifecycleManager] App show"),this.isPageVisible=!0,this.stateManager.getState()===t.PAUSED&&this.resume().catch(e=>{console.error("[LifecycleManager] Auto resume failed:",e)})}),null===(n=wx.onAppHide)||void 0===n||n.call(wx,()=>{console.log("[LifecycleManager] App hide"),this.isPageVisible=!1,this.stateManager.isRunning()&&this.pause().catch(e=>{console.error("[LifecycleManager] Auto pause failed:",e)})}))}getPageVisibility(){return this.isPageVisible}}e.AvatarSDK=class{constructor(e){this.validateConfig(e),this.config=this.mergeDefaultConfig(e),this.eventBus=new u,this.stateManager=new E(this.eventBus),this.lifecycleManager=new g(this.eventBus,this.stateManager),this.modules=new Map,this.plugins=new Map,console.log("[AvatarSDK] SDK instance created")}async init(){try{console.log("[AvatarSDK] Initializing SDK..."),await this.lifecycleManager.init(),this.eventBus.emit(a.READY),this.config.onReady&&this.config.onReady(),console.log("[AvatarSDK] SDK initialized successfully")}catch(e){console.error("[AvatarSDK] Initialization failed:",e);const t=e instanceof r?e:new r(s.INIT_FAILED,"Initialization failed",e);throw this.handleError(t),t}}async start(){try{console.log("[AvatarSDK] Starting SDK..."),await this.lifecycleManager.start(),console.log("[AvatarSDK] SDK started successfully")}catch(e){throw console.error("[AvatarSDK] Start failed:",e),e}}async pause(){try{console.log("[AvatarSDK] Pausing SDK..."),await this.lifecycleManager.pause(),console.log("[AvatarSDK] SDK paused successfully")}catch(e){throw console.error("[AvatarSDK] Pause failed:",e),e}}async resume(){try{console.log("[AvatarSDK] Resuming SDK..."),await this.lifecycleManager.resume(),console.log("[AvatarSDK] SDK resumed successfully")}catch(e){throw console.error("[AvatarSDK] Resume failed:",e),e}}async destroy(){try{console.log("[AvatarSDK] Destroying SDK..."),await this.lifecycleManager.destroy();for(const[e,t]of this.modules)t.destroy&&await t.destroy();this.modules.clear();for(const[e,t]of this.plugins)t.uninstall&&t.uninstall();this.plugins.clear(),this.eventBus.emit(a.DESTROY),this.eventBus.destroy(),console.log("[AvatarSDK] SDK destroyed successfully")}catch(e){throw console.error("[AvatarSDK] Destroy failed:",e),e}}async speak(e,t){if(!this.stateManager.canOperate())throw new r(s.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Speaking:",e)}async playAnimation(e,t){if(!this.stateManager.canOperate())throw new r(s.INIT_FAILED,"SDK is not ready for operation");console.log("[AvatarSDK] Playing animation:",e)}async stopAnimation(){console.log("[AvatarSDK] Stopping animation")}getState(){return this.stateManager.getState()}getStatus(){return this.stateManager.getConnectionStatus()}on(e,t){this.eventBus.on(e,t)}once(e,t){this.eventBus.once(e,t)}off(e,t){this.eventBus.off(e,t)}use(e){this.plugins.has(e.name)?console.warn(`[AvatarSDK] Plugin ${e.name} already installed`):(console.log(`[AvatarSDK] Installing plugin: ${e.name} v${e.version}`),e.install(this),this.plugins.set(e.name,e))}registerModule(e,t){this.modules.has(e)?console.warn(`[AvatarSDK] Module ${e} already registered`):(console.log(`[AvatarSDK] Registering module: ${e}`),this.modules.set(e,t))}getModule(e){return this.modules.get(e)}getConfig(){return{...this.config}}getEventBus(){return this.eventBus}getStateManager(){return this.stateManager}getLifecycleManager(){return this.lifecycleManager}validateConfig(e){if(!e.appId)throw new r(s.CONFIG_INVALID,"appId is required");if(!e.appSecret)throw new r(s.CONFIG_INVALID,"appSecret is required");if(!e.serverUrl)throw new r(s.CONFIG_INVALID,"serverUrl is required");if(!e.canvas||!e.canvas.id)throw new r(s.CONFIG_INVALID,"canvas.id is required")}mergeDefaultConfig(e){return{...e,render:{quality:"auto",fps:30,enableOptimization:!0,backgroundColor:"#000000",antialias:!0,...e.render},audio:{enabled:!0,volume:1,autoPlay:!0,format:"mp3",...e.audio},network:{timeout:3e4,retryTimes:3,heartbeatInterval:3e4,autoReconnect:!0,reconnectDelay:3e3,...e.network},cache:{enabled:!0,maxSize:50,ttl:36e5,strategy:"hybrid",...e.cache},logger:{level:"info",upload:!1,console:!0,...e.logger}}}handleError(e){console.error("[AvatarSDK] Error:",e),this.eventBus.emit(a.ERROR,e),this.config.onError&&this.config.onError(e)}},e.EventBus=u,e.LifecycleManager=g,e.StateManager=E});
//# sourceMappingURL=core.js.map
